<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»ºç­‘æŒä¹…åŒ–æµ‹è¯• - Pet Plan</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #2c3e50;
            color: white;
        }
        .test-section {
            background: #34495e;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        .test-button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #357abd;
        }
        .test-result {
            background: #27ae60;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .test-error {
            background: #e74c3c;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .building-list {
            background: #2c3e50;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .building-item {
            background: #34495e;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <h1>ğŸ—ï¸ å»ºç­‘æŒä¹…åŒ–æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•è¯´æ˜</h2>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•å»ºç­‘æ•°æ®æŒä¹…åŒ–åŠŸèƒ½ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæµ‹è¯•ï¼š</p>
        <ol>
            <li>ç‚¹å‡»"æ·»åŠ æµ‹è¯•å»ºç­‘"æŒ‰é’®ï¼Œåœ¨é¢†åœ°ä¸­æ·»åŠ ä¸€äº›å»ºç­‘</li>
            <li>ç‚¹å‡»"æŸ¥çœ‹å½“å‰å»ºç­‘"æŒ‰é’®ï¼Œç¡®è®¤å»ºç­‘å·²æ·»åŠ </li>
            <li>åˆ·æ–°é¡µé¢ï¼ˆF5 æˆ– Ctrl+Rï¼‰</li>
            <li>å†æ¬¡ç‚¹å‡»"æŸ¥çœ‹å½“å‰å»ºç­‘"æŒ‰é’®ï¼Œç¡®è®¤å»ºç­‘ä»ç„¶å­˜åœ¨</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•æ“ä½œ</h2>
        <button class="test-button" onclick="addTestBuildings()">æ·»åŠ æµ‹è¯•å»ºç­‘</button>
        <button class="test-button" onclick="viewCurrentBuildings()">æŸ¥çœ‹å½“å‰å»ºç­‘</button>
        <button class="test-button" onclick="clearAllBuildings()">æ¸…é™¤æ‰€æœ‰å»ºç­‘</button>
        <button class="test-button" onclick="testDataPersistence()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•ç»“æœ</h2>
        <div id="test-results"></div>
    </div>

    <div class="test-section">
        <h2>å½“å‰å»ºç­‘åˆ—è¡¨</h2>
        <div id="building-list" class="building-list">
            <p>ç‚¹å‡»"æŸ¥çœ‹å½“å‰å»ºç­‘"æŒ‰é’®æŸ¥çœ‹å»ºç­‘åˆ—è¡¨</p>
        </div>
    </div>

    <script type="module">
        import { TerritorySystem } from './js/modules/territory-system.js';
        import ResourceSystem from './js/modules/resource-system.js';

        // åˆå§‹åŒ–ç³»ç»Ÿ
        const resourceSystem = ResourceSystem.getInstance();
        const territorySystem = new TerritorySystem(resourceSystem);

        // åŠ è½½æ•°æ®
        resourceSystem.loadFromLocalStorage();
        territorySystem.loadFromLocalStorage();

        // æ·»åŠ æµ‹è¯•å»ºç­‘
        window.addTestBuildings = function() {
            try {
                // ç¡®ä¿æœ‰è¶³å¤Ÿçš„èµ„æº
                resourceSystem.setCoins(100000);
                resourceSystem.setCrystals(10000);
                resourceSystem.saveToLocalStorage();

                // æ·»åŠ ä¸€äº›æµ‹è¯•å»ºç­‘
                const testBuildings = [
                    { type: 'training_ground', position: { x: 0, y: 0 } },
                    { type: 'temple', position: { x: 1, y: 0 } },
                    { type: 'workshop', position: { x: 0, y: 1 } },
                    { type: 'crystal_mine', position: { x: 1, y: 1 } }
                ];

                let successCount = 0;
                testBuildings.forEach(building => {
                    if (territorySystem.debugBuildBuilding(building.type, building.position)) {
                        successCount++;
                    }
                });

                showResult(`æˆåŠŸæ·»åŠ  ${successCount} ä¸ªæµ‹è¯•å»ºç­‘`, 'success');
                viewCurrentBuildings();
            } catch (error) {
                showResult(`æ·»åŠ æµ‹è¯•å»ºç­‘å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // æŸ¥çœ‹å½“å‰å»ºç­‘
        window.viewCurrentBuildings = function() {
            try {
                const buildings = territorySystem.getBuildings();
                const buildingList = document.getElementById('building-list');
                
                if (buildings.length === 0) {
                    buildingList.innerHTML = '<p>å½“å‰æ²¡æœ‰å»ºç­‘</p>';
                } else {
                    buildingList.innerHTML = buildings.map(building => {
                        const buildingData = territorySystem.buildingData[building.type];
                        return `
                            <div class="building-item">
                                <div>
                                    <strong>${buildingData.name}</strong> (${building.type})
                                    <br>
                                    <small>ä½ç½®: (${building.position.x}, ${building.position.y}) | ç­‰çº§: ${building.level}</small>
                                </div>
                                <div>${getBuildingIcon(building.type)}</div>
                            </div>
                        `;
                    }).join('');
                }

                showResult(`å½“å‰å…±æœ‰ ${buildings.length} ä¸ªå»ºç­‘`, 'success');
            } catch (error) {
                showResult(`æŸ¥çœ‹å»ºç­‘å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // æ¸…é™¤æ‰€æœ‰å»ºç­‘
        window.clearAllBuildings = function() {
            try {
                territorySystem.clearTerritoryData();
                resourceSystem.setCoins(100000);
                resourceSystem.setCrystals(10000);
                resourceSystem.saveToLocalStorage();
                
                showResult('æ‰€æœ‰å»ºç­‘å·²æ¸…é™¤ï¼Œèµ„æºå·²é‡ç½®', 'success');
                viewCurrentBuildings();
            } catch (error) {
                showResult(`æ¸…é™¤å»ºç­‘å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // è¿è¡Œå®Œæ•´æµ‹è¯•
        window.testDataPersistence = function() {
            try {
                showResult('å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•...', 'info');
                
                // 1. æ¸…é™¤ç°æœ‰æ•°æ®
                territorySystem.clearTerritoryData();
                showResult('æ­¥éª¤1: æ¸…é™¤ç°æœ‰æ•°æ® âœ“', 'success');
                
                // 2. æ·»åŠ æµ‹è¯•å»ºç­‘
                resourceSystem.setCoins(100000);
                resourceSystem.setCrystals(10000);
                resourceSystem.saveToLocalStorage();
                
                const testBuildings = [
                    { type: 'training_ground', position: { x: 0, y: 0 } },
                    { type: 'temple', position: { x: 1, y: 0 } }
                ];
                
                testBuildings.forEach(building => {
                    territorySystem.debugBuildBuilding(building.type, building.position);
                });
                
                showResult('æ­¥éª¤2: æ·»åŠ æµ‹è¯•å»ºç­‘ âœ“', 'success');
                
                // 3. ä¿å­˜æ•°æ®
                territorySystem.saveToLocalStorage();
                showResult('æ­¥éª¤3: ä¿å­˜æ•°æ® âœ“', 'success');
                
                // 4. é‡æ–°åŠ è½½æ•°æ®
                const newTerritorySystem = new TerritorySystem(resourceSystem);
                newTerritorySystem.loadFromLocalStorage();
                const loadedBuildings = newTerritorySystem.getBuildings();
                
                if (loadedBuildings.length === testBuildings.length + 1) { // +1 for main_base
                    showResult('æ­¥éª¤4: æ•°æ®æŒä¹…åŒ–æµ‹è¯•é€šè¿‡ âœ“', 'success');
                    showResult('ğŸ‰ å»ºç­‘æ•°æ®æŒä¹…åŒ–åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼', 'success');
                } else {
                    showResult(`æ­¥éª¤4: æ•°æ®æŒä¹…åŒ–æµ‹è¯•å¤±è´¥ - æœŸæœ› ${testBuildings.length + 1} ä¸ªå»ºç­‘ï¼Œå®é™… ${loadedBuildings.length} ä¸ª`, 'error');
                }
                
            } catch (error) {
                showResult(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // æ˜¾ç¤ºç»“æœ
        function showResult(message, type) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = type === 'error' ? 'test-error' : 'test-result';
            resultDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // è·å–å»ºç­‘å›¾æ ‡
        function getBuildingIcon(buildingType) {
            const icons = {
                'training_ground': 'ğŸ‹ï¸',
                'temple': 'ğŸ›ï¸',
                'main_base': 'ğŸ°',
                'barracks': 'ğŸ•ï¸',
                'workshop': 'ğŸ”¨',
                'crystal_mine': 'ğŸ’',
                'library': 'ğŸ“š',
                'hospital': 'ğŸ¥',
                'tower': 'ğŸ—¼',
                'market': 'ğŸª'
            };
            return icons[buildingType] || 'ğŸ—ï¸';
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå½“å‰å»ºç­‘
        viewCurrentBuildings();
    </script>
</body>
</html>
