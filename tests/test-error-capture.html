<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Plan - é”™è¯¯æ•è·</title>
    <link rel="stylesheet" href="css/style.css?v=32">
    <link rel="stylesheet" href="css/menu.css">
    <link rel="stylesheet" href="css/character-management.css">
    <link rel="stylesheet" href="css/save-system.css">
    <link rel="stylesheet" href="css/pet-system.css">
    <style>
        #error-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            z-index: 999999;
            display: none;
            overflow: auto;
            padding: 20px;
            font-family: monospace;
        }
        #error-overlay.show {
            display: block;
        }
        .error-title {
            color: #e74c3c;
            font-size: 24px;
            margin-bottom: 20px;
        }
        .error-details {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #e74c3c;
        }
        .error-stack {
            white-space: pre-wrap;
            font-size: 12px;
            color: #ccc;
        }
        .console-log {
            background: #1e1e1e;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 2px 5px;
        }
        .log-error { color: #e74c3c; }
        .log-warn { color: #f39c12; }
        .log-info { color: #3498db; }
        .log-success { color: #2ecc71; }
    </style>
</head>
<body>
    <!-- é”™è¯¯è¦†ç›–å±‚ -->
    <div id="error-overlay">
        <div class="error-title">âš ï¸ æ£€æµ‹åˆ°é”™è¯¯</div>
        <div id="error-content"></div>
        <div class="error-title" style="margin-top: 30px;">ğŸ“‹ æ§åˆ¶å°æ—¥å¿—</div>
        <div class="console-log" id="console-log"></div>
    </div>

    <!-- æ¸¸æˆå†…å®¹ -->
    <div class="game-container initial-fade">
        <!-- æ¸¸æˆå†…åŠ è½½åŠ¨ç”» -->
        <div class="game-loading-screen" id="gameLoadingScreen" style="display: none;">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <div class="loading-text">Pet Plan åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- æ‰¹é‡å‡çº§å­èœå• -->
        <div id="upgradeMenu" class="upgrade-menu" style="display: none;">
            <div class="upgrade-menu-content">
                <button class="upgrade-menu-btn" data-times="1">+1</button>
                <button class="upgrade-menu-btn" data-times="10">+10</button>
                <button class="upgrade-menu-btn" data-times="100">+100</button>
            </div>
        </div>

        <!-- è®¾ç½®èœå•æ¨¡æ€æ¡† -->
        <div id="settingsModal" class="modal" style="display: none;">
            <div class="modal-content settings-modal-content">
                <div class="modal-header">
                    <h2>è®¾ç½®</h2>
                    <span class="close-modal" id="closeSettingsModal">&times;</span>
                </div>
                <div class="modal-body">
                    <button id="openSaveMenuBtn" class="menu-btn">ğŸ’¾ å­˜æ¡£ / è¯»æ¡£</button>
                </div>
            </div>
        </div>

        <div class="game-area">
            <!-- æ¸¸æˆç”»å¸ƒ -->
            <canvas id="gameCanvas" width="400" height="435"></canvas>
            
            <!-- æ¸¸æˆå†…UIè¦†ç›–å±‚ -->
            <div class="game-ui-overlay">
                <!-- é¡¶éƒ¨çŠ¶æ€ä¿¡æ¯ -->
                <div class="game-top-status">
                    <div class="game-status-left">
                        <div class="player-avatar">
                            <img src="./images/rw/rw3.png" alt="rw3" style="width: 100%; height: 100%; object-fit: contain; border-radius: 50%;">
                        </div>
                        <div class="currency-display">
                            <div class="currency-item" title="é‡‘å¸">
                                <span class="currency-icon">ğŸ’°</span>
                                <span id="coins">0</span>
                            </div>
                            <div class="currency-item" title="çº¢å®çŸ³">
                                <span class="currency-icon">ğŸ”´</span>
                                <span id="gems">0</span>
                            </div>
                            <div class="currency-item" title="æ°´æ™¶">
                                <span class="currency-icon">ğŸ’</span>
                                <span id="crystals">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="game-status-center">
                    </div>
                    <div class="game-status-right">
                        <div class="status-icon" title="å•†åŸ">ğŸ›’</div>
                        <div class="status-icon" title="æ´»åŠ¨">ğŸ“…</div>
                        <div class="status-icon" title="æ—¶é—´">â°</div>
                        <div class="status-icon" title="æ—¥å¸¸">ğŸ“Š</div>
                        <div class="status-icon" id="settingsBtn" title="è®¾ç½®">âš™ï¸</div>
                    </div>
                </div>
                
                <!-- å…³å¡éš¾åº¦æ˜¾ç¤º - åœ¨æ¸¸æˆç”»å¸ƒå†… -->
                <div class="stage-info-overlay">
                    <div class="stage-info">
                        <span class="stage-name">æ™®é€š</span>
                        <span class="stage-level">1-1</span>
                    </div>
                </div>
                
                <!-- åŠŸèƒ½æŒ‰é’®åŒºåŸŸ - ç§»åˆ°æ¸¸æˆç”»å¸ƒå†… -->
                <div class="function-buttons-overlay">
                    <button class="function-btn auto-btn">è‡ªåŠ¨</button>
                    <button class="function-btn attack-btn">+</button>
                    <button class="function-btn hp-btn">+</button>
                    <button class="function-btn regen-btn">+</button>
                    <button class="function-btn add-btn">+</button>
                    <button class="function-btn add-btn">+</button>
                    <button class="function-btn add-btn">+</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ•è·æ‰€æœ‰é”™è¯¯
        const logs = [];
        const errorOverlay = document.getElementById('error-overlay');
        const errorContent = document.getElementById('error-content');
        const consoleLog = document.getElementById('console-log');

        function addLog(message, type = 'info') {
            const entry = { message, type, time: new Date().toLocaleTimeString() };
            logs.push(entry);
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${entry.time}] ${message}`;
            consoleLog.appendChild(logEntry);
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        function showError(error) {
            errorOverlay.classList.add('show');
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-details';
            errorDiv.innerHTML = `
                <strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message}<br>
                <strong>é”™è¯¯ä½ç½®:</strong> ${error.filename || 'æœªçŸ¥'}:${error.lineno || '?'}:${error.colno || '?'}<br>
                <div class="error-stack"><strong>å †æ ˆä¿¡æ¯:</strong><br>${error.stack || error.error?.stack || 'æ— '}</div>
            `;
            errorContent.appendChild(errorDiv);
        }

        // æ‹¦æˆªconsoleæ–¹æ³•
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };

        console.log = function(...args) {
            addLog(args.join(' '), 'info');
            originalConsole.log.apply(console, args);
        };

        console.error = function(...args) {
            addLog(args.join(' '), 'error');
            originalConsole.error.apply(console, args);
        };

        console.warn = function(...args) {
            addLog(args.join(' '), 'warn');
            originalConsole.warn.apply(console, args);
        };

        // æ•è·å…¨å±€é”™è¯¯
        window.addEventListener('error', (event) => {
            addLog(`ERROR: ${event.message}`, 'error');
            showError(event);
            event.preventDefault();
        });

        // æ•è·Promise rejection
        window.addEventListener('unhandledrejection', (event) => {
            addLog(`Promise Rejection: ${event.reason}`, 'error');
            showError({ 
                message: event.reason?.message || event.reason, 
                stack: event.reason?.stack || 'æ— å †æ ˆä¿¡æ¯'
            });
            event.preventDefault();
        });

        addLog('é”™è¯¯æ•è·å™¨å·²å¯åŠ¨', 'success');
    </script>

    <script type="module" src="js/main.js"></script>
</body>
</html>
