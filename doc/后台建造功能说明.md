# 领地系统后台建造功能测试指南

## 功能说明

领地系统现在支持基于真实时间的后台建造，具有以下特性：

1. **时间戳建造系统**：建造过程基于真实时间戳，而非客户端计时器
2. **页面切换不影响**：切换到其他页面或关闭浏览器，建造会在后台继续
3. **自动完成检测**：重新加载页面时自动检查并完成已完成的建造
4. **数据持久化**：建造队列保存到 localStorage 和存档系统中

## 核心改进

### TerritorySystem 改进

1. **新增建造队列**：`territoryData.buildQueue` 存储所有正在建造的任务
2. **新方法**：
   - `startBuildBuilding()` - 开始建造，加入建造队列
   - `checkAndCompleteBuildings()` - 检查并完成所有已完成的建造
   - `getBuildTaskAtPosition()` - 获取指定位置的建造任务
   - `getBuildProgress()` - 获取建造进度（0-100）
   - `getBuildRemainingTime()` - 获取剩余时间（秒）
   - `instantCompleteBuild()` - 立即完成建造（用于加速道具）

3. **数据持久化**：
   - 建造队列随领地数据一起保存到 localStorage
   - 加载数据时自动检查并完成离线期间完成的建造

### TerritoryScene 改进

1. **进度监控器**：每 100ms 更新一次所有建造中的进度条
2. **自动完成**：定时检查并完成已完成的建造，自动刷新 UI
3. **资源清理**：页面卸载时清理定时器，防止内存泄漏
4. **UI 更新**：`updateSlots()` 方法优先检查建造任务，正确显示建造状态

## 测试步骤

### 测试 1：基本建造功能

1. 打开 `http://localhost:8000/territory.html`
2. 点击任意解锁的空地块（带 + 号）
3. 选择一个建筑开始建造
4. 观察进度条从 0% 增长到 100%
5. 5秒后建筑自动完成并显示

**预期结果**：建造进度平滑增长，完成后自动显示建筑图标和等级

### 测试 2：页面刷新后恢复建造

1. 开始建造一个建筑（5秒完成）
2. 在建造进行到 50% 左右时刷新页面（F5 或 Cmd+R）
3. 观察页面重新加载后的状态

**预期结果**：
- 如果建造未完成：显示建造中状态，进度条从正确位置继续
- 如果建造已完成：直接显示完成的建筑

### 测试 3：切换页面后台建造

1. 开始建造一个建筑（5秒完成）
2. 立即点击底部导航栏的"角色"按钮，跳转到主页面
3. 等待 5 秒以上
4. 点击底部导航栏的"领地"按钮，返回领地页面

**预期结果**：返回时建筑已经完成，显示为完成状态

### 测试 4：离线建造（模拟关闭游戏）

1. 开始建造一个建筑
2. 立即关闭浏览器标签页
3. 等待 5 秒以上
4. 重新打开 `http://localhost:8000/territory.html`

**预期结果**：打开页面后，建筑显示为已完成状态

### 测试 5：多个建筑同时建造

1. 在不同的地块上开始建造 2-3 个建筑
2. 观察所有进度条是否同步更新
3. 刷新页面或切换页面后返回

**预期结果**：
- 所有进度条平滑增长
- 刷新后所有建造任务正确恢复
- 到达完成时间后依次完成

### 测试 6：资源扣除时机

1. 记录当前金币和水晶数量
2. 开始建造一个建筑
3. 观察资源立即被扣除

**预期结果**：
- 点击建造后立即扣除资源
- 刷新页面后资源保持扣除状态（不会重复扣除）

## 技术细节

### 建造任务数据结构

```javascript
{
    id: "build_crystal_mine_1699999999999",
    type: "crystal_mine",
    position: { x: 0, y: 0 },
    startTime: 1699999999999,  // 开始时间戳
    endTime: 1700000004999,     // 结束时间戳
    buildTime: 5000             // 建造时长（毫秒）
}
```

### 存档数据结构

```javascript
{
    level: 1,
    size: { width: 20, height: 20 },
    buildings: [...],
    buildQueue: [...]  // 新增：建造队列
}
```

## 常见问题

### Q: 建造时间可以修改吗？
A: 可以。在 `TerritoryScene.startBuilding()` 方法中，第三个参数是建造时间（毫秒）：
```javascript
const buildTask = this.territorySystem.startBuildBuilding(buildingType, position, 5000);
```

### Q: 如何实现建造加速？
A: 使用 `instantCompleteBuild(taskId)` 方法立即完成建造：
```javascript
this.territorySystem.instantCompleteBuild(buildTask.id);
```

### Q: 建造队列有数量限制吗？
A: 目前没有限制，可以在 `startBuildBuilding()` 中添加队列长度检查。

### Q: 如何清除所有建造任务？
A: 可以直接清空队列：
```javascript
this.territorySystem.territoryData.buildQueue = [];
this.territorySystem.saveToLocalStorage();
```

## 代码位置

- 核心逻辑：`/js/modules/territory-system.js`
- UI 实现：`/js/scenes/territory-scene.js`
- 存档系统：`/js/modules/save-system.js`

## 后续优化建议

1. 添加建造队列长度限制（如最多3个）
2. 实现建造加速道具
3. 添加建造取消功能（退还部分资源）
4. 显示建造完成通知
5. 根据建筑类型设置不同的建造时间
6. 添加建造动画效果
