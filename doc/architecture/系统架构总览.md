# 系统架构总览

## 整体架构

Pet Plan 采用单页面应用 (SPA) 架构，基于 HTML5 Canvas 技术构建。整个系统采用模块化设计，主要分为以下几个层次：

```
┌─────────────────────────────────────┐
│            UI 表现层                │
│  (HTML + CSS + Canvas 渲染)        │
├─────────────────────────────────────┤
│           游戏逻辑层                 │
│     (Game 类 + 各子系统)           │
├─────────────────────────────────────┤
│           数据管理层                 │
│    (玩家数据 + 游戏状态)            │
├─────────────────────────────────────┤
│           持久化层                   │
│   (LocalStorage + 存档系统)        │
└─────────────────────────────────────┘
```

## 核心组件

### 1. Game 类 (游戏主控制器)
- **位置**: `js/main.js`
- **职责**: 游戏主控制器，初始化和协调各个子系统
- **主要功能**:
  - 初始化所有系统
  - 设置系统间引用
  - 提供存档管理接口
  - 快捷键和页面事件处理

### 2. GameCore (游戏核心)
- **位置**: `js/modules/game-core.js`
- **职责**: 游戏循环、场景渲染
- **主要功能**:
  - 游戏主循环 (requestAnimationFrame)
  - 帧率控制 (60 FPS)
  - 场景渲染（天空、山脉、地面、云朵）
  - 协调各系统的 update/render

### 3. PlayerSystem (玩家系统)
- **位置**: `js/modules/player-system.js`
- **职责**: 管理玩家角色数据和成长
- **主要功能**:
  - 三维属性（力量/敏捷/智力）
  - 战斗属性管理
  - 升级系统和战力计算
  - 角色渲染

### 4. CombatSystem (战斗系统)
- **位置**: `js/modules/combat-system.js`
- **职责**: 处理所有战斗相关逻辑
- **主要功能**:
  - 怪物生成和管理
  - 子弹系统
  - 碰撞检测
  - 伤害计算和奖励

### 5. PetSystem (宠物系统) ⭐新增
- **位置**: `js/modules/pet-system.js`
- **职责**: 宠物收集、养成、编队和战斗
- **主要功能**:
  - 宠物图鉴和解锁
  - 宠物养成（喂食、训练）
  - 编队管理（前后排）
  - 宠物战斗和技能

### 6. TerritorySystem (领地系统)
- **位置**: `js/modules/territory-system.js`
- **职责**: 领地建设和管理
- **主要功能**:
  - 建筑建造和升级
  - 建造队列
  - 资源产出
  - 属性加成

### 7. ResourceSystem (资源系统)
- **位置**: `js/modules/resource-system.js`
- **职责**: 游戏货币和资源管理
- **主要功能**:
  - 金币/红宝石/水晶管理
  - 数字格式化
  - UI 货币显示更新

### 8. SaveSystem (存档系统)
- **位置**: `js/modules/save-system.js`
- **职责**: 游戏数据持久化
- **主要功能**:
  - 多槽位存档
  - 自动保存
  - 导入/导出

### 9. UISystem (用户界面系统)
- **位置**: `js/modules/ui-system.js`
- **职责**: 用户界面和交互
- **主要功能**:
  - 界面渲染和更新
  - 弹窗管理
  - 用户交互处理

## 数据流

### 游戏状态数据流
```
用户操作 → 事件处理 → 游戏逻辑更新 → 数据状态变更 → UI 更新 → 渲染更新
```

### 游戏主循环数据流
```
requestAnimationFrame
    ↓
GameCore.gameLoop()
    ↓
┌───────────────────────────────────────────┐
│  GameCore.update(deltaTime)               │
│    ├── PlayerSystem.update()              │
│    ├── CombatSystem.update()              │
│    │     └── PetSystem.update()           │
│    ├── UISystem.update()                  │
│    └── SaveSystem.updateAutoSave()        │
└───────────────────────────────────────────┘
    ↓
┌───────────────────────────────────────────┐
│  GameCore.render(ctx)                     │
│    ├── 绘制场景 (天空、山、地面、云)      │
│    ├── PlayerSystem.render()              │
│    ├── PetSystem.render()                 │
│    └── CombatSystem.render()              │
└───────────────────────────────────────────┘
```

### 存档数据流
```
用户触发保存
    ↓
SaveSystem.saveGame()
    ↓
┌───────────────────────────────────────────┐
│  getGameState()                           │
│    ├── PlayerSystem.getSaveData()         │
│    ├── TerritorySystem.getSaveData()      │
│    ├── ResourceSystem.getSaveData()       │
│    ├── CombatSystem.getSaveData()         │
│    └── PetSystem.getSaveData()            │
└───────────────────────────────────────────┘
    ↓
JSON.stringify() → LocalStorage
```

## 模块依赖关系

```
                    ┌─────────────┐
                    │   Game      │
                    │  (main.js)  │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│   GameCore    │  │   SaveSystem  │  │   UISystem    │
└───────┬───────┘  └───────────────┘  └───────────────┘
        │                  │                  │
        │          ┌───────┴───────┐          │
        │          ▼               ▼          │
        │  ┌───────────────┐ ┌───────────────┐│
        │  │  SaveUI       │ │  PetUI        ││
        │  └───────────────┘ └───────────────┘│
        │                                      │
┌───────┴──────────────────────────────────────┘
│
├──▶ PlayerSystem ◀───┐
│                     │
├──▶ CombatSystem ◀───┤──▶ PetSystem
│         │           │         │
│         ▼           │         ▼
│    怪物/子弹/爆炸   │    宠物战斗
│                     │
├──▶ TerritorySystem ─┘
│         │
│         ▼
│    建筑/属性加成
│
└──▶ ResourceSystem (单例，被所有系统引用)
          │
          ▼
     货币管理/数字格式化
```

## 设计原则

### 1. 单例模式
关键系统采用单例模式，确保全局唯一实例：
- ResourceSystem
- TerritorySystem
- SaveSystem
- PetSystem

### 2. 单一职责原则
每个模块只负责特定的功能：
- GameCore 负责游戏循环和场景渲染
- PlayerSystem 只管理玩家相关逻辑
- CombatSystem 只处理战斗相关功能
- ResourceSystem 只管理货币资源

### 3. 松耦合设计
模块间通过明确的接口进行通信：
- 使用 `setSystems()` 方法设置系统引用
- 通过 `getSaveData()` / `loadSaveData()` 统一存档接口

### 4. 数据驱动
游戏状态通过数据对象管理，UI 根据数据状态自动更新

### 5. 事件驱动
用户交互通过事件系统处理，支持多种输入方式

## 性能优化策略

### 1. 渲染优化
- 使用 `requestAnimationFrame` 进行流畅渲染
- 帧率控制 (60 FPS 限制)
- Canvas 配置优化 (`alpha: false`, `desynchronized: true`)
- 禁用图像平滑 (`imageSmoothingEnabled = false`)

### 2. DOM 更新优化
- 货币显示使用缓存对比，仅变化时更新
- 批量 DOM 操作

### 3. 内存管理
- 及时清理过期的游戏对象（子弹、爆炸）
- 单例模式避免重复创建
- 对象复用

### 4. 计算优化
- 数值清洗避免 NaN
- 安全加法避免溢出

## 扩展性设计

### 1. 模块化架构
新功能可以作为独立模块添加：
```javascript
// 1. 创建新模块
class NewSystem { ... }

// 2. 在 main.js 中导入和初始化
import NewSystem from './modules/new-system.js';
this.newSystem = new NewSystem();

// 3. 设置系统引用
this.gameCore.setSystems(..., this.newSystem);

// 4. 实现存档接口
getSaveData() { ... }
loadSaveData(data) { ... }
```

### 2. 配置化设计
游戏参数通过配置对象管理：
```javascript
// 宠物配置
this.petDatabase = { ... };

// 建筑配置  
this.buildingData = { ... };

// 扩张配置
this.expansionConfig = { ... };
```

### 3. 存档接口标准化
所有需要持久化的系统实现统一接口：
```javascript
class AnySystem {
    getSaveData() {
        return { /* 需要保存的数据 */ };
    }
    
    loadSaveData(data) {
        if (data) {
            // 恢复数据
        }
    }
}
```

## 技术选型理由

### HTML5 Canvas
- **优势**: 高性能 2D 渲染，丰富的图形 API
- **适用场景**: 游戏画面渲染，动画效果
- **配置优化**: 禁用 alpha 通道、异步渲染

### ES6+ Modules
- **优势**: 原生模块化，无需构建工具
- **适用场景**: 代码组织，依赖管理
- **导入方式**: `import/export` 语法

### LocalStorage
- **优势**: 简单易用，无需后端
- **适用场景**: 游戏存档，本地持久化
- **限制**: 5-10MB 容量限制

### CSS3
- **优势**: 丰富的样式和动画效果
- **适用场景**: UI 界面，响应式设计
- **特性使用**: Flexbox、动画、渐变

## 文件结构

```
PetPlan/
├── index.html              # 主游戏页面
├── territory.html          # 领地系统页面
│
├── css/
│   ├── style.css           # 主样式
│   ├── menu.css            # 菜单样式
│   ├── character-management.css
│   ├── pet-system.css
│   └── save-system.css
│
├── js/
│   ├── main.js             # 游戏入口和 Game 类
│   ├── README.md           # 模块说明
│   ├── modules/
│   │   ├── index.js        # 模块索引
│   │   ├── game-core.js    # 游戏核心
│   │   ├── player-system.js
│   │   ├── combat-system.js
│   │   ├── pet-system.js
│   │   ├── pet-ui.js
│   │   ├── territory-system.js
│   │   ├── resource-system.js
│   │   ├── save-system.js
│   │   ├── save-ui.js
│   │   └── ui-system.js
│   └── scenes/
│       └── territory-scene.js
│
├── images/
│   ├── cw/                 # 宠物图片
│   └── rw/                 # 角色图片
│
└── doc/                    # 项目文档
```

## 未来架构演进

### 短期目标
1. 完善宠物进化和融合系统
2. 添加更多建筑类型
3. 优化移动端体验

### 中期目标
1. 引入 TypeScript 提升代码质量
2. 添加单元测试
3. 支持 PWA 特性（离线游戏）

### 长期目标
1. 支持多人在线功能
2. 引入 WebSocket 实时通信
3. 云存档同步
