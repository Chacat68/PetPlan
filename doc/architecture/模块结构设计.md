# 模块结构设计

## 当前模块结构

### 文件组织结构
```
Pet_Plan/
├── index.html              # 主页面文件
├── js/
│   ├── game.js            # 游戏核心逻辑 (主文件)
│   └── modules/           # 模块目录 (待扩展)
├── css/
│   ├── style.css          # 主样式文件
│   ├── menu.css           # 菜单样式
│   └── character-management.css  # 角色管理样式
├── images/                # 图片资源
│   ├── cw/               # 角色图片
│   └── rw/               # 其他图片
└── doc/                  # 文档目录
```

## 模块拆分建议

### 1. 游戏核心模块
**文件**: `js/modules/game-core.js`
```javascript
class GameCore {
    constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.isRunning = false;
        this.lastTime = 0;
    }
    
    // 游戏循环
    gameLoop(currentTime) { }
    
    // 更新逻辑
    update(deltaTime) { }
    
    // 渲染逻辑
    render() { }
    
    // 启动/停止游戏
    start() { }
    stop() { }
}
```

### 2. 玩家系统模块
**文件**: `js/modules/player-system.js`
```javascript
class PlayerSystem {
    constructor() {
        this.player = {
            // 玩家属性
            x: 35,
            y: 0,
            width: 51,
            height: 51,
            // 战斗属性
            level: 1,
            hp: 100,
            maxHp: 100,
            attack: 20,
            // 其他属性...
        };
    }
    
    // 更新玩家状态
    updatePlayer(deltaTime) { }
    
    // 绘制玩家
    drawPlayer(ctx) { }
    
    // 玩家移动
    movePlayer(direction) { }
    
    // 生命恢复
    regenerateHealth(deltaTime) { }
}
```

### 3. 战斗系统模块
**文件**: `js/modules/combat-system.js`
```javascript
class CombatSystem {
    constructor() {
        this.monsters = [];
        this.bullets = [];
        this.explosions = [];
        this.combatTexts = [];
    }
    
    // 怪物管理
    spawnMonster() { }
    updateMonsters(deltaTime) { }
    drawMonsters(ctx) { }
    
    // 子弹系统
    fireBullet(target) { }
    updateBullets(deltaTime) { }
    drawBullets(ctx) { }
    
    // 碰撞检测
    checkCollisions() { }
    isColliding(rect1, rect2) { }
    
    // 战斗效果
    createExplosion(x, y) { }
    addCombatText(x, y, text, color) { }
}
```

### 4. 升级系统模块
**文件**: `js/modules/upgrade-system.js`
```javascript
class UpgradeSystem {
    constructor(player, resources) {
        this.player = player;
        this.resources = resources;
        this.upgradeCosts = {
            attack: 10,
            hp: 15,
            // 其他升级成本...
        };
    }
    
    // 升级属性
    upgradeAttribute(attribute, increase) { }
    
    // 批量升级
    bulkUpgradeAttribute(attribute, times) { }
    
    // 计算升级成本
    calculateUpgradeCost(attribute, times) { }
    
    // 检查是否可以升级
    canUpgrade(attribute, times) { }
    
    // 更新升级按钮状态
    updateUpgradeButtons() { }
}
```

### 5. 资源系统模块
**文件**: `js/modules/resource-system.js`
```javascript
class ResourceSystem {
    constructor() {
        this.coins = 1000;
        this.rubies = 50;
        this.numberSuffixes = ['', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
    }
    
    // 数字格式化
    formatNumber(num) { }
    
    // 添加资源
    addCoins(amount) { }
    addRubies(amount) { }
    
    // 消费资源
    spendCoins(amount) { }
    spendRubies(amount) { }
    
    // 检查资源是否足够
    hasEnoughCoins(amount) { }
    hasEnoughRubies(amount) { }
}
```

### 6. 用户界面系统模块
**文件**: `js/modules/ui-system.js`
```javascript
class UISystem {
    constructor(game) {
        this.game = game;
        this.modals = {
            character: null,
            characterManagement: null
        };
    }
    
    // 更新 UI 显示
    updateUI() { }
    
    // 更新货币显示
    updateCurrencyDisplay() { }
    
    // 更新升级项目显示
    updateUpgradeItems() { }
    
    // 更新总战力显示
    updateTotalPower() { }
    
    // 显示/隐藏弹窗
    showModal(modalType) { }
    hideModal(modalType) { }
    
    // 绑定事件
    bindEvents() { }
}
```

### 7. 事件系统模块
**文件**: `js/modules/event-system.js`
```javascript
class EventSystem {
    constructor() {
        this.listeners = new Map();
    }
    
    // 添加事件监听器
    on(event, callback) { }
    
    // 移除事件监听器
    off(event, callback) { }
    
    // 触发事件
    emit(event, data) { }
    
    // 绑定 DOM 事件
    bindDOMEvents() { }
    
    // 绑定游戏事件
    bindGameEvents() { }
}
```

## 模块间通信

### 1. 事件总线模式
```javascript
// 事件系统作为中央通信枢纽
class Game {
    constructor() {
        this.eventSystem = new EventSystem();
        this.playerSystem = new PlayerSystem(this.eventSystem);
        this.combatSystem = new CombatSystem(this.eventSystem);
        this.upgradeSystem = new UpgradeSystem(this.eventSystem);
        this.resourceSystem = new ResourceSystem(this.eventSystem);
        this.uiSystem = new UISystem(this.eventSystem);
    }
}

// 模块间通过事件通信
this.eventSystem.emit('player:upgrade', { attribute: 'attack', amount: 5 });
this.eventSystem.on('player:upgrade', (data) => {
    // 处理升级事件
});
```

### 2. 依赖注入模式
```javascript
class Game {
    constructor() {
        // 创建共享服务
        this.resourceSystem = new ResourceSystem();
        this.eventSystem = new EventSystem();
        
        // 注入依赖
        this.playerSystem = new PlayerSystem(this.resourceSystem, this.eventSystem);
        this.upgradeSystem = new UpgradeSystem(this.playerSystem, this.resourceSystem);
    }
}
```

## 模块加载策略

### 1. 动态加载
```javascript
// 按需加载模块
async function loadModule(moduleName) {
    const module = await import(`./modules/${moduleName}.js`);
    return module.default;
}

// 使用示例
const PlayerSystem = await loadModule('player-system');
```

### 2. 模块注册表
```javascript
class ModuleRegistry {
    constructor() {
        this.modules = new Map();
    }
    
    register(name, module) {
        this.modules.set(name, module);
    }
    
    get(name) {
        return this.modules.get(name);
    }
    
    async load(name) {
        if (!this.modules.has(name)) {
            const module = await import(`./modules/${name}.js`);
            this.register(name, module.default);
        }
        return this.get(name);
    }
}
```

## 配置管理

### 1. 游戏配置
**文件**: `js/config/game-config.js`
```javascript
export const GAME_CONFIG = {
    // 画布配置
    canvas: {
        width: 400,
        height: 435
    },
    
    // 玩家配置
    player: {
        initialX: 35,
        initialY: 0,
        width: 51,
        height: 51,
        initialHp: 100,
        initialAttack: 20
    },
    
    // 战斗配置
    combat: {
        monsterSpawnInterval: 2000,
        attackInterval: 800,
        bulletSpeed: 300
    },
    
    // 升级配置
    upgrade: {
        costMultiplier: 1.5,
        maxLevels: {
            multiShot: 1001,
            crit: 1001,
            attackSpeed: 201
        }
    }
};
```

### 2. UI 配置
**文件**: `js/config/ui-config.js`
```javascript
export const UI_CONFIG = {
    // 颜色主题
    colors: {
        primary: '#4CAF50',
        secondary: '#45a049',
        danger: '#e74c3c',
        warning: '#f39c12',
        success: '#2ed573'
    },
    
    // 动画配置
    animations: {
        duration: 300,
        easing: 'ease'
    },
    
    // 布局配置
    layout: {
        modalWidth: 400,
        modalHeight: 600
    }
};
```

## 重构步骤

### 第一阶段：基础模块拆分
1. 创建模块目录结构
2. 提取玩家系统模块
3. 提取战斗系统模块
4. 提取资源系统模块

### 第二阶段：UI 和事件系统
1. 提取 UI 系统模块
2. 实现事件系统
3. 重构事件绑定逻辑

### 第三阶段：配置和优化
1. 实现配置管理系统
2. 优化模块加载
3. 添加错误处理

### 第四阶段：测试和文档
1. 添加单元测试
2. 完善文档
3. 性能优化

## 模块化优势

### 1. 可维护性
- 代码结构清晰
- 职责分离明确
- 易于定位和修复问题

### 2. 可扩展性
- 新功能独立开发
- 不影响现有模块
- 支持插件化扩展

### 3. 可测试性
- 模块独立测试
- 模拟依赖关系
- 提高测试覆盖率

### 4. 团队协作
- 并行开发
- 减少代码冲突
- 提高开发效率
