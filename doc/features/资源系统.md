# èµ„æºç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## 1. æ¦‚è¿°

èµ„æºç³»ç»Ÿè´Ÿè´£ç®¡ç†æ¸¸æˆä¸­çš„æ‰€æœ‰è´§å¸èµ„æºï¼ŒåŒ…æ‹¬é‡‘å¸ã€çº¢å®çŸ³å’Œæ°´æ™¶çš„è·å–ã€æ¶ˆè€—ã€æ˜¾ç¤ºå’ŒæŒä¹…åŒ–ã€‚

## 2. ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ResourceSystem                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   è´§å¸ç®¡ç†    â”‚  â”‚   æ•°å­—æ ¼å¼åŒ–   â”‚  â”‚   UI æ›´æ–°     â”‚   â”‚
â”‚  â”‚  - é‡‘å¸      â”‚  â”‚  - ç®€å†™è½¬æ¢   â”‚  â”‚  - ä¸»ç•Œé¢    â”‚   â”‚
â”‚  â”‚  - çº¢å®çŸ³    â”‚  â”‚  - åƒåˆ†ä½     â”‚  â”‚  - è§’è‰²ç®¡ç†   â”‚   â”‚
â”‚  â”‚  - æ°´æ™¶      â”‚  â”‚  - è´Ÿæ•°å¤„ç†   â”‚  â”‚  - é¢†åœ°ç•Œé¢   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚   æ•°æ®æŒä¹…åŒ–   â”‚  â”‚   å…¼å®¹é€‚é…    â”‚                       â”‚
â”‚  â”‚  - ä¿å­˜      â”‚  â”‚  - é¢†åœ°ç³»ç»Ÿ   â”‚                       â”‚
â”‚  â”‚  - åŠ è½½      â”‚  â”‚  - gold/crystalâ”‚                      â”‚
â”‚  â”‚  - å­˜æ¡£é›†æˆ   â”‚  â”‚               â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3. è´§å¸ç±»å‹

| è´§å¸ | å±æ€§å | å›¾æ ‡ | åˆå§‹å€¼ | ä¸»è¦ç”¨é€” |
|------|--------|------|--------|----------|
| é‡‘å¸ | coins | ğŸ’° | 1000 | å‡çº§å±æ€§ã€å»ºé€ å»ºç­‘ã€å…»æˆå® ç‰© |
| çº¢å®çŸ³ | rubies | ğŸ”´ | 50 | è§£é”é«˜çº§å® ç‰©ã€åŠ é€Ÿå»ºé€  |
| æ°´æ™¶ | crystals | ğŸ’ | 200 | å»ºç­‘å‡çº§ã€é¢†åœ°æ‰©å¼  |

## 4. æ ¸å¿ƒåŠŸèƒ½

### 4.1 è´§å¸æ“ä½œ

```javascript
// æ·»åŠ è´§å¸
addCoins(amount)      // æ·»åŠ é‡‘å¸
addRubies(amount)     // æ·»åŠ çº¢å®çŸ³
addCrystals(amount)   // æ·»åŠ æ°´æ™¶

// æ¶ˆè€—è´§å¸ (è¿”å› boolean)
spendCoins(amount)    // æ¶ˆè€—é‡‘å¸
spendRubies(amount)   // æ¶ˆè€—çº¢å®çŸ³
spendCrystals(amount) // æ¶ˆè€—æ°´æ™¶

// æ£€æŸ¥æ˜¯å¦è¶³å¤Ÿ
hasEnoughCoins(amount)    // é‡‘å¸æ˜¯å¦è¶³å¤Ÿ
hasEnoughRubies(amount)   // çº¢å®çŸ³æ˜¯å¦è¶³å¤Ÿ
hasEnoughCrystals(amount) // æ°´æ™¶æ˜¯å¦è¶³å¤Ÿ

// è·å–å½“å‰å€¼
getCoins()    // è·å–é‡‘å¸æ•°
getRubies()   // è·å–çº¢å®çŸ³æ•°
getCrystals() // è·å–æ°´æ™¶æ•°

// è®¾ç½®å€¼
setCoins(amount)
setRubies(amount)
setCrystals(amount)
```

### 4.2 æ•°å­—æ ¼å¼åŒ–

æ¸¸æˆé‡‡ç”¨å­—æ¯åç¼€çš„å¤§æ•°å­—æ ¼å¼åŒ–æ–¹æ¡ˆï¼š

| æ•°å€¼ | æ˜¾ç¤º | è¯´æ˜ |
|------|------|------|
| 0 - 999 | åŸæ•°å­— | ç›´æ¥æ˜¾ç¤º |
| 1,000 | 1A | åƒ |
| 1,000,000 | 1B | ç™¾ä¸‡ |
| 1,000,000,000 | 1C | åäº¿ |
| ... | ... | ä»¥æ­¤ç±»æ¨ |
| 1,000 Z | 1AA | è¶…è¿‡Zåç»„åˆ |

```javascript
formatNumber(num) {
    // å°äº1000ç›´æ¥æ˜¾ç¤º
    if (abs < 1000) {
        return Math.floor(abs).toString();
    }
    
    // è®¡ç®—å¹‚æ¬¡
    while (value >= 1000) {
        value /= 1000;
        power++;
    }
    
    // ç”Ÿæˆåç¼€
    // power 1-26: A-Z
    // power 27+: AA, AB, AC...
    
    // æ ¼å¼åŒ–æ•°å€¼
    // >=100 å–æ•´
    // >=10 ä¿ç•™1ä½å°æ•°
    // <10 ä¿ç•™2ä½å°æ•°
}
```

### 4.3 UIæ›´æ–°

```javascript
updateCurrencyDisplay() {
    // æ›´æ–°ä¸»ç•Œé¢
    document.getElementById('coins').textContent = formatNumber(coins);
    document.getElementById('gems').textContent = formatNumber(rubies);
    document.getElementById('crystals').textContent = formatNumber(crystals);
    
    // æ›´æ–°è§’è‰²ç®¡ç†ç•Œé¢
    updateCharacterManagementCurrency();
}
```

**ä¼˜åŒ–ç­–ç•¥ï¼š**
- ä½¿ç”¨ `_lastDisplay` ç¼“å­˜ä¸Šæ¬¡æ˜¾ç¤ºå€¼
- ä»…å½“æ•°å€¼å˜åŒ–æ—¶æ‰æ›´æ–° DOM
- å‡å°‘ä¸å¿…è¦çš„ DOM æ“ä½œ

## 5. é¢†åœ°ç³»ç»Ÿå…¼å®¹

ä¸ºå…¼å®¹é¢†åœ°ç³»ç»Ÿçš„å‘½åä¹ æƒ¯ï¼Œæä¾›äº†åˆ«åæ¥å£ï¼š

```javascript
// é¢†åœ°ç³»ç»Ÿä½¿ç”¨ gold/crystal åç§°
get gold() {
    return this.coins;
}

get crystal() {
    return this.crystals;
}

// æ‰¹é‡èµ„æºæ£€æŸ¥å’Œæ¶ˆè€—
hasEnoughResources(cost) {
    // cost: { gold: number, crystal: number }
    return this.coins >= cost.gold && this.crystals >= cost.crystal;
}

spendResources(cost) {
    // cost: { gold: number, crystal: number }
    if (this.hasEnoughResources(cost)) {
        this.coins -= cost.gold;
        this.crystals -= cost.crystal;
        this.updateCurrencyDisplay();
        return true;
    }
    return false;
}
```

## 6. æ•°æ®æŒä¹…åŒ–

### 6.1 LocalStorage å­˜å‚¨

```javascript
saveToLocalStorage() {
    const resourceData = {
        coins: this.coins,
        rubies: this.rubies,
        crystals: this.crystals,
        timestamp: Date.now()
    };
    localStorage.setItem('pet-plan-resources', JSON.stringify(resourceData));
}

loadFromLocalStorage() {
    const savedData = localStorage.getItem('pet-plan-resources');
    if (savedData) {
        const resourceData = JSON.parse(savedData);
        this.coins = resourceData.coins || 1000;
        this.rubies = resourceData.rubies || 50;
        this.crystals = resourceData.crystals || 0;
        this.updateCurrencyDisplay();
    }
}
```

### 6.2 å­˜æ¡£ç³»ç»Ÿé›†æˆ

```javascript
getSaveData() {
    return {
        coins: this.coins,
        rubies: this.rubies,
        crystals: this.crystals
    };
}

loadSaveData(data) {
    if (data) {
        this.coins = data.coins ?? this.coins;
        this.rubies = data.rubies ?? this.rubies;
        this.crystals = data.crystals ?? this.crystals;
        this.updateCurrencyDisplay();
    }
}
```

## 7. èµ„æºè·å–é€”å¾„

### 7.1 é‡‘å¸è·å–

| æ¥æº | æ•°é‡ | è¯´æ˜ |
|------|------|------|
| å‡»æ€æ€ªç‰© | 5 + ç©å®¶ç­‰çº§ + æ€ªç‰©å±æ€§ | åŸºç¡€æ‰è½ |
| é¢†åœ°å·¥åŠ | 50-200/å°æ—¶ | æ ¹æ®å»ºç­‘ç­‰çº§ |
| é¢†åœ°å¸‚åœº | 100-400/å°æ—¶ | æ ¹æ®å»ºç­‘ç­‰çº§ |

### 7.2 çº¢å®çŸ³è·å–

| æ¥æº | æ•°é‡ | æ¦‚ç‡ |
|------|------|------|
| å‡»æ€æ€ªç‰© | 1-3 | 10% |

### 7.3 æ°´æ™¶è·å–

| æ¥æº | æ•°é‡ | æ¦‚ç‡ |
|------|------|------|
| å‡»æ€æ€ªç‰© | 1-2 | 5% |
| é¢†åœ°æ°´æ™¶çŸ¿ | 10-50/å°æ—¶ | æ ¹æ®å»ºç­‘ç­‰çº§ |
| é¢†åœ°å¸‚åœº | 5-30/å°æ—¶ | æ ¹æ®å»ºç­‘ç­‰çº§ |

## 8. èµ„æºæ¶ˆè€—é¡¹ç›®

### 8.1 ç©å®¶å‡çº§

| å±æ€§ | åˆå§‹æˆæœ¬ | æˆæœ¬å¢é•¿ |
|------|----------|----------|
| æ”»å‡»åŠ› | 10ğŸ’° | Ã—1.5 |
| ç”Ÿå‘½å€¼ | 15ğŸ’° | Ã—1.5 |
| é˜²å¾¡åŠ› | 12ğŸ’° | Ã—1.5 |
| ç”Ÿå‘½å›å¤ | 20ğŸ’° | Ã—1.5 |
| æš´å‡»ä¼¤å®³ | 25ğŸ’° | Ã—1.5 |
| æ”»å‡»é€Ÿåº¦ | 30ğŸ’° | Ã—1.5 |
| æš´å‡»ç‡ | 35ğŸ’° | Ã—1.5 |
| è¿å°„ | 40ğŸ’° | Ã—1.5 |
| ä¸‰è¿å°„ | 50ğŸ’° | Ã—1.5 |

### 8.2 å® ç‰©ç³»ç»Ÿ

| æ“ä½œ | æˆæœ¬ | è¯´æ˜ |
|------|------|------|
| è§£é”å® ç‰© | 500-50000ğŸ’° + 0-1000ğŸ”´ | æ ¹æ®ç¨€æœ‰åº¦ |
| å–‚é£Ÿ | 50ğŸ’° Ã— ç­‰çº§ | æ¢å¤çŠ¶æ€ |
| è®­ç»ƒ | 100ğŸ’° Ã— ç­‰çº§ | è·å–ç»éªŒ |

### 8.3 é¢†åœ°å»ºç­‘

| å»ºç­‘ | 1çº§æˆæœ¬ | 2çº§æˆæœ¬ | 3çº§æˆæœ¬ |
|------|---------|---------|---------|
| è®­ç»ƒåœº | 1000ğŸ’° | 5000ğŸ’°+500ğŸ’ | 15000ğŸ’°+1500ğŸ’ |
| ç¥åº™ | 1000ğŸ’° | 5000ğŸ’°+500ğŸ’ | 15000ğŸ’°+1500ğŸ’ |
| å·¥åŠ | 3000ğŸ’°+300ğŸ’ | 12000ğŸ’°+1200ğŸ’ | 30000ğŸ’°+3000ğŸ’ |
| æ°´æ™¶çŸ¿ | 5000ğŸ’° | 20000ğŸ’°+2000ğŸ’ | 50000ğŸ’°+5000ğŸ’ |

## 9. å•ä¾‹æ¨¡å¼

èµ„æºç³»ç»Ÿé‡‡ç”¨å•ä¾‹æ¨¡å¼ï¼Œç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼š

```javascript
class ResourceSystem {
    static instance = null;
    
    static getInstance() {
        if (!ResourceSystem.instance) {
            ResourceSystem.instance = new ResourceSystem();
        }
        return ResourceSystem.instance;
    }
}
```

## 10. å†…éƒ¨å·¥å…·æ–¹æ³•

### 10.1 æ•°å€¼æ¸…æ´—

```javascript
_sanitizeAmount(amount) {
    const n = Number(amount);
    // éæ•°å­—/æ— é™/è´Ÿæ•° â†’ 0
    if (!Number.isFinite(n) || n <= 0) return 0;
    return Math.floor(n);
}
```

### 10.2 å®‰å…¨åŠ æ³•

```javascript
_safeSum(base, delta) {
    const b = Number.isFinite(base) ? base : 0;
    const d = Number.isFinite(delta) ? delta : 0;
    const sum = b + d;
    // é˜²æ­¢è´Ÿæ•°
    return sum < 0 ? 0 : sum;
}
```

## 11. è°ƒè¯•åŠŸèƒ½

```javascript
// å¼€å¯è°ƒè¯•æ—¥å¿—
this.debug = true;

// è°ƒè¯•æ—¥å¿—ç¤ºä¾‹
if (this.debug) {
    console.log('èµ„æºæ‰£é™¤å‰:', { coins, crystals, cost });
    console.log('èµ„æºæ‰£é™¤å:', { coins, crystals });
}
```

## 12. DOM å…ƒç´ å¼•ç”¨

### 12.1 ä¸»ç•Œé¢

| å…ƒç´ ID | æ˜¾ç¤ºå†…å®¹ |
|--------|----------|
| coins | é‡‘å¸æ•°é‡ |
| gems | çº¢å®çŸ³æ•°é‡ |
| crystals | æ°´æ™¶æ•°é‡ |

### 12.2 è§’è‰²ç®¡ç†ç•Œé¢

é€šè¿‡é€‰æ‹©å™¨è·å–ï¼š
```javascript
document.querySelectorAll('.character-management-modal .resource-value')
// [0] - é‡‘å¸
// [1] - çº¢å®çŸ³  
// [2] - æ°´æ™¶
```

## 13. æ€§èƒ½ä¼˜åŒ–

1. **DOM æ›´æ–°èŠ‚æµ**
   - ä½¿ç”¨ `_lastDisplay` ç¼“å­˜
   - ä»…å˜åŒ–æ—¶æ›´æ–°

2. **æ•°å€¼è®¡ç®—ä¼˜åŒ–**
   - ä½¿ç”¨ä½è¿ç®—æ›¿ä»£é™¤æ³•
   - é¿å…é‡å¤è®¡ç®—

3. **å†…å­˜ä¼˜åŒ–**
   - å¤ç”¨æ ¼å¼åŒ–ç»“æœ
   - é¿å…ä¸´æ—¶å¯¹è±¡åˆ›å»º

## 14. é”™è¯¯å¤„ç†

```javascript
try {
    localStorage.setItem('pet-plan-resources', JSON.stringify(resourceData));
} catch (error) {
    console.error('ä¿å­˜èµ„æºæ•°æ®å¤±è´¥:', error);
    // LocalStorage æ»¡æˆ–ç¦ç”¨æ—¶çš„é™çº§å¤„ç†
}
```

## 15. API é€ŸæŸ¥è¡¨

| æ–¹æ³• | å‚æ•° | è¿”å›å€¼ | è¯´æ˜ |
|------|------|--------|------|
| getInstance | - | ResourceSystem | è·å–å•ä¾‹ |
| formatNumber | num | string | æ ¼å¼åŒ–æ•°å­— |
| addCoins | amount | void | æ·»åŠ é‡‘å¸ |
| addRubies | amount | void | æ·»åŠ çº¢å®çŸ³ |
| addCrystals | amount | void | æ·»åŠ æ°´æ™¶ |
| spendCoins | amount | boolean | æ¶ˆè€—é‡‘å¸ |
| spendRubies | amount | boolean | æ¶ˆè€—çº¢å®çŸ³ |
| spendCrystals | amount | boolean | æ¶ˆè€—æ°´æ™¶ |
| hasEnoughCoins | amount | boolean | æ£€æŸ¥é‡‘å¸ |
| hasEnoughRubies | amount | boolean | æ£€æŸ¥çº¢å®çŸ³ |
| hasEnoughCrystals | amount | boolean | æ£€æŸ¥æ°´æ™¶ |
| getResourceData | - | Object | è·å–æ‰€æœ‰èµ„æº |
| setResourceData | data | void | è®¾ç½®æ‰€æœ‰èµ„æº |
| getSaveData | - | Object | è·å–å­˜æ¡£æ•°æ® |
| loadSaveData | data | void | åŠ è½½å­˜æ¡£æ•°æ® |
| saveToLocalStorage | - | void | ä¿å­˜åˆ°æœ¬åœ° |
| loadFromLocalStorage | - | boolean | ä»æœ¬åœ°åŠ è½½ |
