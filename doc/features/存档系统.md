# 存档系统文档

## 概述

存档系统为 Pet Plan 游戏提供了完整的数据持久化功能，支持多槽位存档、自动保存、导出/导入等功能。

## 功能特性

### 1. 多槽位存档
- 支持 5 个独立的存档槽位
- 每个槽位可以独立保存和加载游戏进度
- 显示每个存档的基本信息（保存时间、玩家等级、金币数量）

### 2. 自动保存
- 游戏每 30 秒自动保存到槽位 1
- 自动保存时会显示提示通知
- 可在游戏核心的 update 循环中自动触发

### 3. 快捷键支持
- **F5**: 快速保存到槽位 1
- **F9**: 快速加载槽位 1

### 4. 导出/导入功能
- 支持将存档导出为 JSON 文件
- 支持从 JSON 文件导入存档
- 可选择导入到任意槽位

## 技术架构

### 核心模块

#### SaveSystem (`save-system.js`)
存档系统核心逻辑模块，负责：
- 获取和恢复游戏状态
- 保存/加载到 LocalStorage
- 导出/导入 JSON 文件
- 自动保存定时器管理

#### SaveUI (`save-ui.js`)
存档用户界面模块，负责：
- 创建存档管理界面
- 显示存档槽位信息
- 处理用户交互（保存、加载、删除、导出、导入）
- 显示通知消息

### 数据结构

存档数据格式：
```javascript
{
    version: '1.0.0',           // 存档版本
    timestamp: 1699999999999,   // 时间戳
    player: {                   // 玩家数据
        player: {
            level: 1,
            hp: 100,
            maxHp: 100,
            attack: 20,
            // ... 其他属性
            upgradeCosts: {...}
        }
    },
    territory: {                // 领地数据
        level: 1,
        size: { width: 20, height: 20 },
        buildings: [...]
    },
    resources: {                // 资源数据
        coins: 1000,
        rubies: 50,
        crystals: 0
    },
    combat: {                   // 战斗数据
        monsterSpawnInterval: 2000,
        attackInterval: 800,
        attackRange: 500
    },
    slotInfo: {                 // 槽位元数据
        slot: 1,
        savedAt: '2025/11/10 12:00:00',
        playerLevel: 1,
        coins: 1000
    }
}
```

## 使用方法

### 在游戏中集成

1. **初始化存档系统**
```javascript
import { getSaveSystemInstance } from './modules/save-system.js';
import SaveUI from './modules/save-ui.js';

// 获取存档系统实例
this.saveSystem = getSaveSystemInstance();

// 设置系统引用
this.saveSystem.setSystems(
    this.playerSystem,
    this.territorySystem,
    this.resourceSystem,
    this.combatSystem
);

// 初始化存档UI
this.saveUI = new SaveUI(this.saveSystem);
```

2. **在游戏核心中添加自动保存**
```javascript
// 在 game-core.js 的 update 方法中
update(deltaTime) {
    // ... 其他更新逻辑
    
    // 更新存档系统（自动保存）
    if (this.saveSystem) {
        this.saveSystem.updateAutoSave(deltaTime);
    }
}
```

3. **在各个系统中实现存档接口**

每个系统需要实现两个方法：

```javascript
// 获取存档数据
getSaveData() {
    return {
        // 返回需要保存的数据
    };
}

// 加载存档数据
loadSaveData(data) {
    if (data) {
        // 恢复数据到系统状态
    }
}
```

### API 使用示例

```javascript
// 保存游戏到槽位 2
game.saveToSlot(2);

// 从槽位 3 加载游戏
game.loadFromSlot(3);

// 获取所有存档信息
const saves = game.getAllSaves();

// 删除槽位 4 的存档
game.deleteSave(4);

// 导出槽位 1 的存档
game.exportSave(1);

// 导入存档到槽位 5
await game.importSave(file, 5);

// 快速保存（槽位1）
game.saveGame();

// 快速加载（槽位1）
game.loadGame();
```

## 用户界面

### 存档菜单按钮
- 位置：屏幕左下角（底部导航上方）
- 图标：💾 存档
- 点击打开存档管理界面

### 存档管理界面

包含以下部分：

1. **存档槽位列表**
   - 显示 5 个存档槽位
   - 每个槽位显示：槽位号、保存时间、玩家等级、金币数量
   - 操作按钮：保存、加载、导出、删除

2. **导入存档区域**
   - 文件选择按钮
   - 目标槽位选择下拉框
   - 导入按钮

3. **快捷键提示**
   - 显示可用的快捷键
   - 提示自动保存功能

## 样式自定义

存档系统的样式定义在 `css/save-system.css` 中，可以根据游戏主题进行自定义。

主要样式类：
- `.save-menu-btn` - 存档菜单按钮
- `.save-modal` - 模态框容器
- `.save-modal-content` - 模态框内容
- `.save-slot` - 存档槽位
- `.save-slot-btn` - 槽位操作按钮

## 注意事项

1. **浏览器兼容性**
   - 使用 LocalStorage，需要浏览器支持
   - 文件导出/导入使用 Blob API 和 FileReader

2. **数据安全**
   - 存档数据存储在浏览器 LocalStorage 中
   - 清除浏览器数据会删除存档
   - 建议用户定期导出存档备份

3. **版本兼容**
   - 存档包含版本号字段
   - 未来更新时需考虑向后兼容性

4. **性能优化**
   - 自动保存使用定时器，避免频繁保存
   - 大型存档可能影响 LocalStorage 容量限制（通常 5-10MB）

## 扩展建议

未来可以考虑添加：
1. 云存档同步功能
2. 存档加密保护
3. 存档版本迁移工具
4. 存档对比功能
5. 多平台存档同步

## 故障排除

### 存档无法保存
- 检查浏览器是否支持 LocalStorage
- 检查 LocalStorage 是否已满
- 查看浏览器控制台错误信息

### 加载存档后数据不正确
- 确认各系统已实现 `loadSaveData` 方法
- 检查数据格式是否匹配
- 尝试刷新页面

### 导入存档失败
- 确认文件格式为有效的 JSON
- 检查文件是否包含必要的字段（version、timestamp）
- 查看控制台错误信息
