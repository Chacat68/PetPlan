# 离线系统文档

## 概述

离线系统为玩家提供了在游戏离线时继续获得收益的机制。当玩家关闭游戏后，系统仍会计算玩家的离线收益，包括资源产出、被动收入等。

## 功能概述

### 核心功能

1. **离线收益计算** - 根据离线时长计算玩家获得的资源
2. **被动产出** - 领地建筑、宠物等持续产生资源
3. **收益上限** - 防止离线收益过度，设置最大离线时长限制
4. **收益通知** - 玩家返回游戏时显示离线期间的收益

## 离线收益来源

### 建筑产出

领地中的资源产出建筑在玩家离线时继续产出：

| 建筑 | 产出资源 | 产出速率 |
|------|----------|----------|
| 工坊 | 金币 | 每分钟 50-200 |
| 水晶矿 | 水晶 | 每分钟 10-50 |
| 图书馆 | 经验 | 每分钟 10-30 |

### 其他收入来源

1. **宠物收益** - 编队中的宠物产生经验或资源
2. **被动收入** - 玩家的各项属性产生的收入
3. **占领收益** - 占领的区域产生的资源

## 系统架构

### 核心模块

**OfflineSystem** (`offline-system.js`)
- 记录玩家离线时间
- 计算离线期间的收益
- 应用收益到玩家账户
- 管理收益上限和规则

## 数据结构

### 离线记录

```javascript
{
    offlineStartTime: 1699999999999,   // 离线开始时间戳
    offlineEndTime: 1700000099999,     // 离线结束时间戳
    offlineDuration: 100000,           // 离线时长（毫秒）
    revenue: {                         // 离线收益
        coins: 10000,
        rubies: 100,
        crystals: 50,
        experience: 500
    },
    buildings: [                       // 计入收益的建筑
        { id: 'workshop_1', revenue: 5000 },
        { id: 'crystal_mine_1', revenue: 50 }
    ]
}
```

## 使用方法

### 在游戏中集成

```javascript
import { getOfflineSystemInstance } from './modules/offline-system.js';

// 获取离线系统实例
const offlineSystem = getOfflineSystemInstance();

// 初始化（游戏启动时）
offlineSystem.init();

// 设置离线开始（游戏关闭时）
offlineSystem.setOfflineStart();

// 计算和应用离线收益（游戏加载时）
const revenue = offlineSystem.calculateOfflineRevenue();
offlineSystem.applyOfflineRevenue(revenue);

// 获取离线收益信息
const info = offlineSystem.getOfflineInfo();
```

## 收益计算规则

### 基础计算公式

```
离线收益 = 基础产出速率 × 离线时长 × 建筑等级加成 × 玩家等级加成

其中：
- 基础产出速率：建筑的标准产出速度
- 离线时长：分钟为单位
- 建筑等级加成：更高等级建筑产出更多
- 玩家等级加成：更高等级玩家产出更多
```

### 收益上限

为了防止玩家通过长期离线获得过多收益，系统设置了上限：

| 离线时长 | 收益比例 | 说明 |
|----------|----------|------|
| 0-1 小时 | 100% | 完全产出 |
| 1-6 小时 | 100% | 完全产出 |
| 6-12 小时 | 80% | 减产 20% |
| 12-24 小时 | 60% | 减产 40% |
| 24 小时以上 | 40% | 减产 60%，封顶 |

### 最大离线收益

为防止收益过度，系统设置了每次离线的最大收益：

```javascript
const maxOfflineRevenue = {
    coins: 1000000,     // 最多得到 100 万金币
    rubies: 10000,      // 最多得到 1 万红宝石
    crystals: 5000,     // 最多得到 5000 水晶
    experience: 100000  // 最多得到 10 万经验
}
```

## 性能优化

1. **异步计算** - 离线收益计算在后台进行，不影响游戏加载速度
2. **缓存机制** - 缓存建筑产出速率，减少重复计算
3. **分批应用** - 大额收益分批应用，防止 UI 卡顿

## 用户体验

### 离线通知

玩家返回游戏时，系统会显示离线期间的收益总结：

```
离线收益通知：
━━━━━━━━━━━━━━━━━━━━━━━
你在离线期间获得了：
💰 金币：10,000
🔴 红宝石：100
💎 水晶：50
⭐ 经验：500
━━━━━━━━━━━━━━━━━━━━━━━
```

### 收益历史

玩家可以查看最近的离线收益历史，了解哪些建筑产生了多少收益。

## 防作弊机制

1. **时间校准** - 使用服务器时间（模拟）而非客户端时间，防止修改系统时间
2. **收益上限** - 每次离线的收益有硬性上限
3. **数据验证** - 离线收益数据与本地存档进行验证
4. **异常检测** - 检测异常的离线时长（如跨越多个时区）

## 存档集成

离线系统数据完全集成到存档系统：
- 离线开始时间自动记录
- 离线收益自动计算
- 收益历史保存在存档中

## 建议和最佳实践

### 开发者

1. **定期调整** - 根据游戏平衡性调整产出速率
2. **监控数据** - 关注玩家的平均离线时长和收益
3. **防止滥用** - 设置合理的收益上限，防止游戏经济崩溃

### 玩家

1. **合理利用** - 定期上线领取离线收益，加快进度
2. **优化建筑** - 升级高级建筑提升离线收益
3. **平衡游戏** - 不要过度依赖离线收益

---

**版本**：v1.0.0  
**最后更新**：2025年12月14日
