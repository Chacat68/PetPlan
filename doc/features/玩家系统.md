# ç©å®¶ç³»ç»Ÿ

## æ¦‚è¿°

ç©å®¶ç³»ç»Ÿè´Ÿè´£ç®¡ç†æ¸¸æˆä¸­çš„ä¸»è§’è§’è‰²ï¼ŒåŒ…æ‹¬è§’è‰²å±æ€§ã€ç§»åŠ¨ã€åŠ¨ç”»ã€ç”Ÿå‘½å€¼ç®¡ç†ã€å‡çº§ç³»ç»Ÿç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

## ç©å®¶æ•°æ®ç»“æ„

### åŸºç¡€å±æ€§
```javascript
this.player = {
    // ä½ç½®å’Œå°ºå¯¸
    x: 35,                    // Xåæ ‡ (å›ºå®šåœ¨å±å¹•æœ€å·¦è¾¹)
    y: this.canvas.height / 2 - 25.5,  // Yåæ ‡ (å‚ç›´å±…ä¸­)
    width: 51,                // å®½åº¦
    height: 51,               // é«˜åº¦
    
    // ç§»åŠ¨å±æ€§
    speed: 50,                // ç§»åŠ¨é€Ÿåº¦
    direction: 1,             // æœå‘ (1=å³, -1=å·¦)
    animationFrame: 0,        // åŠ¨ç”»å¸§æ•°
    
    // æˆ˜æ–—å±æ€§
    level: 1,                 // ç­‰çº§
    hp: 100,                  // å½“å‰ç”Ÿå‘½å€¼
    maxHp: 100,               // æœ€å¤§ç”Ÿå‘½å€¼
    attack: 20,               // æ”»å‡»åŠ›
    hpRegen: 1,               // ç”Ÿå‘½æ¢å¤é€Ÿåº¦
    critDamage: 150,          // æš´å‡»ä¼¤å®³ç™¾åˆ†æ¯”
    attackSpeed: 1.0,         // æ”»å‡»é€Ÿåº¦
    crit: 5,                  // æš´å‡»ç‡ç™¾åˆ†æ¯”
    multiShot: 1,             // è¿å°„æ•°é‡
    tripleShot: 0,            // ä¸‰è¿å°„æ¦‚ç‡ç™¾åˆ†æ¯”
    
    // å‡çº§æˆæœ¬
    upgradeCosts: {
        attack: 10,
        hp: 15,
        hpRegen: 20,
        critDamage: 25,
        attackSpeed: 30,
        crit: 35,
        multiShot: 40,
        tripleShot: 50
    }
};
```

## æ ¸å¿ƒåŠŸèƒ½

### 1. ç©å®¶æ›´æ–° (updatePlayer)

```javascript
updatePlayer(deltaTime) {
    // æ›´æ–°å¥”è·‘åŠ¨ç”»
    this.player.animationFrame += deltaTime * 0.01;
    
    // äººç‰©å›ºå®šåœ¨æœ€å·¦è¾¹ï¼Œä¸éœ€è¦ç§»åŠ¨å’Œæœå‘é€»è¾‘
    // ä¿æŒå›ºå®šæœå‘å³è¾¹
    this.player.direction = 1;
    
    // ç”Ÿå‘½æ¢å¤
    if (this.player.hp < this.player.maxHp) {
        this.player.hp = Math.min(this.player.maxHp, 
            this.player.hp + this.player.hpRegen * (deltaTime / 1000));
    }
}
```

**åŠŸèƒ½**: æ¯å¸§æ›´æ–°ç©å®¶çŠ¶æ€

**æ›´æ–°å†…å®¹**:
- åŠ¨ç”»å¸§æ•°é€’å¢
- ä¿æŒå›ºå®šæœå‘
- ç”Ÿå‘½å€¼è‡ªåŠ¨æ¢å¤

### 2. ç©å®¶æ¸²æŸ“ (drawPlayer)

```javascript
drawPlayer() {
    // ç¡®ä¿ç©å®¶ç«™åœ¨è‰åœ°ä¸Š
    const groundY = this.mapHeight - 50;
    const playerY = groundY - this.player.height;
    
    // ç©å®¶èº«ä½“ - æ·»åŠ å¥”è·‘åŠ¨ç”»æ•ˆæœ
    const bobOffset = Math.sin(this.player.animationFrame) * 2; // ä¸Šä¸‹æ‘†åŠ¨
    
    // ç»˜åˆ¶è§’è‰²å›¾ç‰‡
    if (this.playerImageLoaded && this.playerImage.complete && this.playerImage.naturalWidth > 0) {
        // è®¡ç®—å›¾ç‰‡ç¼©æ”¾æ¯”ä¾‹ï¼Œä¿æŒå®½é«˜æ¯”
        const imageAspectRatio = this.playerImage.width / this.playerImage.height;
        let drawWidth = this.player.width;
        let drawHeight = this.player.height;
        
        if (imageAspectRatio > 1) {
            // å›¾ç‰‡è¾ƒå®½ï¼Œä»¥é«˜åº¦ä¸ºå‡†
            drawWidth = drawHeight * imageAspectRatio;
        } else {
            // å›¾ç‰‡è¾ƒé«˜ï¼Œä»¥å®½åº¦ä¸ºå‡†
            drawHeight = drawWidth / imageAspectRatio;
        }
        
        // å±…ä¸­ç»˜åˆ¶å›¾ç‰‡
        const drawX = this.player.x + (this.player.width - drawWidth) / 2;
        const drawY = playerY + (this.player.height - drawHeight) / 2 + bobOffset;
        
        this.ctx.drawImage(this.playerImage, drawX, drawY, drawWidth, drawHeight);
    } else {
        // å›¾ç‰‡æœªåŠ è½½æ—¶æ˜¾ç¤ºå ä½ç¬¦
        this.ctx.fillStyle = '#4a90e2';
        this.ctx.fillRect(this.player.x, playerY + bobOffset, this.player.width, this.player.height);
        
        // ç»˜åˆ¶åŠ è½½æç¤ºæˆ–é”™è¯¯ä¿¡æ¯
        this.ctx.fillStyle = '#ffffff';
        this.ctx.font = 'bold 10px Arial';
        this.ctx.textAlign = 'center';
        if (this.playerImage.src && !this.playerImageLoaded) {
            this.ctx.fillText('Loading...', this.player.x + this.player.width/2, playerY + this.player.height/2 + 4 + bobOffset);
        } else {
            this.ctx.fillText('Error', this.player.x + this.player.width/2, playerY + this.player.height/2 + 4 + bobOffset);
        }
    }
    
    // ç»˜åˆ¶ç©å®¶è„šéƒ¨é˜´å½±ï¼ˆåœ¨è‰åœ°ä¸Šï¼‰
    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
    this.ctx.fillRect(this.player.x - 2, groundY - 2, this.player.width + 4, 4);
    
    // å…¨å±æ”»å‡»èŒƒå›´æŒ‡ç¤ºå™¨ï¼ˆå±å¹•è¾¹æ¡†ï¼‰
    if (this.monsters.length > 0) {
        this.ctx.strokeStyle = 'rgba(255, 255, 0, 0.2)';
        this.ctx.lineWidth = 3;
        this.ctx.setLineDash([10, 10]);
        this.ctx.strokeRect(2, 2, this.canvas.width - 4, this.canvas.height - 4);
        this.ctx.setLineDash([]);
    }
    
    // ç”Ÿå‘½å€¼æ¡ - è°ƒæ•´åˆ°ç©å®¶å¤´é¡¶ä¸Šæ–¹
    this.drawHealthBar(this.player.x, playerY - 15, this.player.width, 
                      this.player.hp, this.player.maxHp, '#ff4757', '#2ed573');
}
```

**åŠŸèƒ½**: æ¸²æŸ“ç©å®¶è§’è‰²

**æ¸²æŸ“å†…å®¹**:
- è§’è‰²å›¾ç‰‡æˆ–å ä½ç¬¦
- å¥”è·‘åŠ¨ç”»æ•ˆæœ
- è„šéƒ¨é˜´å½±
- æ”»å‡»èŒƒå›´æŒ‡ç¤ºå™¨
- ç”Ÿå‘½å€¼æ¡

### 3. ç”Ÿå‘½å€¼æ¡æ¸²æŸ“ (drawHealthBar)

```javascript
drawHealthBar(x, y, width, currentHp, maxHp, bgColor, fillColor) {
    const barHeight = 6;
    const hpPercent = currentHp / maxHp;
    
    // èƒŒæ™¯
    this.ctx.fillStyle = bgColor;
    this.ctx.fillRect(x, y, width, barHeight);
    
    // ç”Ÿå‘½å€¼
    this.ctx.fillStyle = fillColor;
    this.ctx.fillRect(x, y, width * hpPercent, barHeight);
    
    // è¾¹æ¡†
    this.ctx.strokeStyle = '#000';
    this.ctx.lineWidth = 1;
    this.ctx.strokeRect(x, y, width, barHeight);
}
```

**åŠŸèƒ½**: ç»˜åˆ¶ç”Ÿå‘½å€¼æ¡

**å‚æ•°**:
- `x, y`: ä½ç½®åæ ‡
- `width`: ç”Ÿå‘½å€¼æ¡å®½åº¦
- `currentHp`: å½“å‰ç”Ÿå‘½å€¼
- `maxHp`: æœ€å¤§ç”Ÿå‘½å€¼
- `bgColor`: èƒŒæ™¯é¢œè‰²
- `fillColor`: å¡«å……é¢œè‰²

## å‡çº§ç³»ç»Ÿ

### 1. å±æ€§å‡çº§ (upgradeAttribute)

```javascript
upgradeAttribute(attribute, increase, silent = false) {
    const cost = this.player.upgradeCosts[attribute];
    const button = document.getElementById(`upgrade${attribute.charAt(0).toUpperCase() + attribute.slice(1)}`);
    
    if (this.coins >= cost) {
        // æ£€æŸ¥è¿å°„å±æ€§é™åˆ¶
        if (attribute === 'multiShot') {
            if (this.player.multiShot >= 100) {
                return; // å·²è¾¾åˆ°æœ€é«˜å€¼
            }
            const currentLevel = Math.floor((this.player.multiShot - 1) / 1) + 1;
            if (currentLevel >= 1001) {
                return; // å·²è¾¾åˆ°æœ€é«˜ç­‰çº§
            }
        }
        
        // æ£€æŸ¥æš´å‡»å±æ€§é™åˆ¶
        if (attribute === 'crit') {
            if (this.player.crit >= 126.2) {
                return; // å·²è¾¾åˆ°æœ€é«˜å€¼
            }
            const currentLevel = Math.floor((this.player.crit - 5) / 1) + 1;
            if (currentLevel >= 1001) {
                return; // å·²è¾¾åˆ°æœ€é«˜ç­‰çº§
            }
        }
        
        // æ£€æŸ¥æ”»å‡»é€Ÿåº¦å±æ€§é™åˆ¶
        if (attribute === 'attackSpeed') {
            if (this.player.attackSpeed >= 8.08) {
                return; // å·²è¾¾åˆ°æœ€é«˜å€¼
            }
            const currentLevel = Math.floor((this.player.attackSpeed - 1.0) / 0.1) + 1;
            if (currentLevel >= 201) {
                return; // å·²è¾¾åˆ°æœ€é«˜ç­‰çº§
            }
        }
        
        // æ£€æŸ¥ä¸‰è¿å°„å±æ€§é™åˆ¶
        if (attribute === 'tripleShot') {
            if (this.player.tripleShot >= 100) {
                return; // å·²è¾¾åˆ°æœ€é«˜å€¼
            }
            const currentLevel = Math.floor((this.player.tripleShot - 0) / 5) + 1;
            if (currentLevel >= 1001) {
                return; // å·²è¾¾åˆ°æœ€é«˜ç­‰çº§
            }
        }
        
        this.coins -= cost;
        
        if (attribute === 'hp') {
            this.player.maxHp += increase;
            this.player.hp += increase;
        } else if (attribute === 'multiShot') {
            this.player.multiShot = Math.min(this.player.multiShot + increase, 100);
        } else if (attribute === 'crit') {
            this.player.crit = Math.min(this.player.crit + increase, 126.2);
        } else if (attribute === 'attackSpeed') {
            this.player.attackSpeed = Math.min(this.player.attackSpeed + increase, 8.08);
        } else if (attribute === 'tripleShot') {
            this.player.tripleShot = Math.min(this.player.tripleShot + increase, 100);
        } else {
            this.player[attribute] += increase;
        }
        
        // å¢åŠ å‡çº§æˆæœ¬
        this.player.upgradeCosts[attribute] = Math.floor(cost * 1.5);
        
        // æ·»åŠ å‡çº§æˆåŠŸåŠ¨ç”»ï¼ˆæ‰¹é‡å‡çº§æ—¶é™é»˜ï¼‰
        if (!silent) {
            this.showUpgradeSuccess(button, attribute);
        }
        
        // å•æ¬¡å‡çº§æ—¶ç«‹å³åˆ·æ–°æŒ‰é’®çŠ¶æ€
        if (!silent) {
            this.updateUpgradeButtons();
        }
    } else {
        // é‡‘å¸ä¸è¶³æ—¶çš„åé¦ˆï¼ˆæ‰¹é‡å‡çº§æ—¶é™é»˜ï¼‰
        if (!silent) {
            this.showInsufficientCoins(button);
        }
    }
}
```

**åŠŸèƒ½**: å‡çº§ç©å®¶å±æ€§

**å‚æ•°**:
- `attribute`: è¦å‡çº§çš„å±æ€§åç§°
- `increase`: å¢åŠ çš„æ•°å€¼
- `silent`: æ˜¯å¦é™é»˜å‡çº§ï¼ˆä¸æ˜¾ç¤ºåŠ¨ç”»ï¼‰

**å‡çº§é™åˆ¶**:
- è¿å°„ (multiShot): æœ€é«˜100%ï¼Œæœ€é«˜ç­‰çº§1001
- æš´å‡» (crit): æœ€é«˜126.2%ï¼Œæœ€é«˜ç­‰çº§1001
- æ”»å‡»é€Ÿåº¦ (attackSpeed): æœ€é«˜8.08ï¼Œæœ€é«˜ç­‰çº§201
- ä¸‰è¿å°„ (tripleShot): æœ€é«˜100%ï¼Œæœ€é«˜ç­‰çº§1001

### 2. æ‰¹é‡å‡çº§ (bulkUpgradeAttribute)

```javascript
bulkUpgradeAttribute(attribute, times) {
    const inc = this.attributeIncreases[attribute];
    const { totalCost, allowedTimes } = this.getBulkUpgradeCost(attribute, times);
    
    if (allowedTimes !== times || this.coins < totalCost) {
        return; // ä¸æ»¡è¶³æ¡ä»¶ï¼Œä¸æ‰§è¡Œ
    }
    
    for (let i = 0; i < times; i++) {
        this.upgradeAttribute(attribute, inc, true); // é™é»˜å‡çº§
    }
    
    // ç»Ÿä¸€åˆ·æ–°
    this.updateUpgradeButtons();
    this.updateUpgradeItems();
    this.updateTotalPower();
}
```

**åŠŸèƒ½**: æ‰¹é‡å‡çº§å±æ€§

**å‚æ•°**:
- `attribute`: è¦å‡çº§çš„å±æ€§åç§°
- `times`: å‡çº§æ¬¡æ•°

### 3. å‡çº§æˆæœ¬è®¡ç®— (getBulkUpgradeCost)

```javascript
getBulkUpgradeCost(attribute, times) {
    let allowedTimes = 0;
    let totalCost = 0;
    let tempValue = this.player[attribute];
    let tempCost = this.player.upgradeCosts[attribute];
    const inc = this.attributeIncreases[attribute];
    
    for (let i = 0; i < times; i++) {
        if (!this.canUpgrade(attribute)) break;
        
        // æ¨¡æ‹Ÿå±æ€§æå‡ï¼Œè€ƒè™‘ä¸Šé™
        if (attribute === 'hp') {
            tempValue = tempValue + inc;
        } else if (attribute === 'multiShot') {
            if (tempValue + inc > 100) break;
            tempValue = Math.min(tempValue + inc, 100);
        } else if (attribute === 'crit') {
            if (tempValue + inc > 126.2) break;
            tempValue = Math.min(tempValue + inc, 126.2);
        } else if (attribute === 'attackSpeed') {
            if (tempValue + inc > 8.08) break;
            tempValue = Math.min(tempValue + inc, 8.08);
        } else if (attribute === 'tripleShot') {
            if (tempValue + inc > 100) break;
            tempValue = Math.min(tempValue + inc, 100);
        } else {
            tempValue = tempValue + inc;
        }
        
        totalCost += tempCost; // ç´¯åŠ å½“å‰æˆæœ¬
        tempCost = Math.floor(tempCost * 1.5); // ä¸‹ä¸€æ¬¡æˆæœ¬æå‡
        allowedTimes++;
    }
    
    return { totalCost, allowedTimes };
}
```

**åŠŸèƒ½**: è®¡ç®—æ‰¹é‡å‡çº§çš„æ€»æˆæœ¬å’Œå…è®¸æ¬¡æ•°

### 4. å‡çº§å¯è¡Œæ€§æ£€æŸ¥ (canUpgrade)

```javascript
canUpgrade(attribute, times = 1) {
    if (attribute === 'multiShot') {
        const currentLevel = Math.floor((this.player.multiShot - 1) / 1) + 1;
        return this.player.multiShot < 100 && currentLevel < 1001;
    }
    if (attribute === 'crit') {
        const currentLevel = Math.floor((this.player.crit - 5) / 1) + 1;
        return this.player.crit < 126.2 && currentLevel < 1001;
    }
    if (attribute === 'attackSpeed') {
        const currentLevel = Math.floor((this.player.attackSpeed - 1.0) / 0.1) + 1;
        return this.player.attackSpeed < 8.08 && currentLevel < 201;
    }
    if (attribute === 'tripleShot') {
        const currentLevel = Math.floor((this.player.tripleShot - 0) / 5) + 1;
        return this.player.tripleShot < 100 && currentLevel < 1001;
    }
    return true; // å…¶ä»–å±æ€§é»˜è®¤å¯å‡çº§
}
```

**åŠŸèƒ½**: æ£€æŸ¥å±æ€§æ˜¯å¦å¯ä»¥ç»§ç»­å‡çº§

## æ€»æˆ˜åŠ›è®¡ç®—

### calculateTotalPower æ–¹æ³•

```javascript
calculateTotalPower() {
    // åŸºç¡€æ”»å‡»åŠ›è´¡çŒ®
    const attackPower = this.player.attack * 10;
    
    // æš´å‡»ä¼¤å®³è´¡çŒ® (ç™¾åˆ†æ¯”è½¬æ¢ä¸ºæ•°å€¼)
    const critDamagePower = this.player.critDamage * 2;
    
    // æ”»å‡»é€Ÿåº¦è´¡çŒ®
    const attackSpeedPower = this.player.attackSpeed * 50;
    
    // æš´å‡»ç‡è´¡çŒ® (ç™¾åˆ†æ¯”è½¬æ¢ä¸ºæ•°å€¼)
    const critPower = this.player.crit * 3;
    
    // è¿å°„è´¡çŒ®
    const multiShotPower = this.player.multiShot * 20;
    
    // ä¸‰è¿å°„è´¡çŒ® (ç™¾åˆ†æ¯”è½¬æ¢ä¸ºæ•°å€¼)
    const tripleShotPower = this.player.tripleShot * 5;
    
    // è®¡ç®—æ€»æˆ˜åŠ›
    const totalPower = Math.floor(attackPower + critDamagePower + attackSpeedPower + critPower + multiShotPower + tripleShotPower);
    
    return totalPower;
}
```

**åŠŸèƒ½**: è®¡ç®—ç©å®¶æ€»æˆ˜åŠ›

**è®¡ç®—å…¬å¼**:
- æ”»å‡»åŠ›: `attack * 10`
- æš´å‡»ä¼¤å®³: `critDamage * 2`
- æ”»å‡»é€Ÿåº¦: `attackSpeed * 50`
- æš´å‡»ç‡: `crit * 3`
- è¿å°„: `multiShot * 20`
- ä¸‰è¿å°„: `tripleShot * 5`

## å‡çº§æŒ‰é’®ç®¡ç†

### 1. å‡çº§æŒ‰é’®æ›´æ–° (updateUpgradeButtons)

```javascript
updateUpgradeButtons() {
    const buttons = {
        'upgradeAttack': { cost: this.player.upgradeCosts.attack, attribute: 'attack' },
        'upgradeHp': { cost: this.player.upgradeCosts.hp, attribute: 'hp' },
        'upgradeHpRegen': { cost: this.player.upgradeCosts.hpRegen, attribute: 'hpRegen' },
        'upgradeCritDamage': { cost: this.player.upgradeCosts.critDamage, attribute: 'critDamage' },
        'upgradeAttackSpeed': { cost: this.player.upgradeCosts.attackSpeed, attribute: 'attackSpeed' },
        'upgradeCrit': { cost: this.player.upgradeCosts.crit, attribute: 'crit' },
        'upgradeMultiShot': { cost: this.player.upgradeCosts.multiShot, attribute: 'multiShot' },
        'upgradeTripleShot': { cost: this.player.upgradeCosts.tripleShot, attribute: 'tripleShot' }
    };
    
    for (const [id, { cost, attribute }] of Object.entries(buttons)) {
        const button = document.getElementById(id);
        const btnCost = button.querySelector('.btn-cost');
        const btnText = button.querySelector('.btn-text');
        
        // è®¡ç®—å½“å‰é‡‘å¸èƒ½å‡çº§çš„æœ€é«˜ç­‰çº§æ•°é‡
        const maxAffordable = this.getMaxAffordableUpgrades(attribute);
        
        // ç‰¹æ®Šå¤„ç†å„ç§æŒ‰é’®çŠ¶æ€
        if (id === 'upgradeMultiShot') {
            const currentLevel = Math.floor((this.player.multiShot - 1) / 1) + 1;
            const isMaxValue = this.player.multiShot >= 100;
            const isMaxLevel = currentLevel >= 1001;
            
            if (isMaxValue || isMaxLevel) {
                button.disabled = true;
                if (btnCost) {
                    btnCost.textContent = isMaxValue ? 'å·²æ»¡' : 'å·²æ»¡çº§';
                }
                if (btnText) {
                    btnText.textContent = 'å¼ºåŒ–';
                }
            } else {
                button.disabled = this.coins < cost;
                if (btnCost) {
                    btnCost.textContent = `ğŸ’° ${this.formatNumber(cost)}`;
                }
                if (btnText) {
                    btnText.textContent = maxAffordable > 0 ? `å¼ºåŒ– +${maxAffordable}` : 'å¼ºåŒ–';
                }
            }
        }
        // ... å…¶ä»–æŒ‰é’®çš„ç‰¹æ®Šå¤„ç†
    }
}
```

**åŠŸèƒ½**: æ›´æ–°æ‰€æœ‰å‡çº§æŒ‰é’®çš„çŠ¶æ€

### 2. å‡çº§é¡¹ç›®æ˜¾ç¤ºæ›´æ–° (updateUpgradeItems)

```javascript
updateUpgradeItems() {
    // æ›´æ–°æ”»å‡»åŠ›
    const attackLevel = document.querySelector('#upgradeAttack').closest('.upgrade-item').querySelector('.upgrade-icon-container .upgrade-level');
    const attackValue = document.querySelector('#upgradeAttack').closest('.upgrade-item').querySelector('.upgrade-value');
    const currentAttackLevel = Math.floor((this.player.attack - 20) / 5) + 1;
    if (attackLevel) attackLevel.textContent = `Lv.${currentAttackLevel}`;
    if (attackValue) attackValue.textContent = this.formatNumber(this.player.attack);
    
    // æ›´æ–°ç”Ÿå‘½
    const hpLevel = document.querySelector('#upgradeHp').closest('.upgrade-item').querySelector('.upgrade-icon-container .upgrade-level');
    const hpValue = document.querySelector('#upgradeHp').closest('.upgrade-item').querySelector('.upgrade-value');
    const currentHpLevel = Math.floor((this.player.maxHp - 100) / 10) + 1;
    if (hpLevel) hpLevel.textContent = `Lv.${currentHpLevel}`;
    if (hpValue) hpValue.textContent = this.formatNumber(this.player.maxHp);
    
    // ... å…¶ä»–å±æ€§çš„æ›´æ–°
}
```

**åŠŸèƒ½**: æ›´æ–°å‡çº§é¡¹ç›®çš„æ˜¾ç¤ºä¿¡æ¯

## åŠ¨ç”»å’Œè§†è§‰æ•ˆæœ

### 1. å‡çº§æˆåŠŸåŠ¨ç”» (showUpgradeSuccess)

```javascript
showUpgradeSuccess(button, attribute) {
    // æ·»åŠ æˆåŠŸåŠ¨ç”»
    button.style.animation = 'pulse 0.6s ease';
    
    // åˆ›å»ºæˆåŠŸæç¤º
    const successText = document.createElement('div');
    successText.textContent = 'å‡çº§æˆåŠŸ!';
    successText.style.cssText = `
        position: absolute;
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: bold;
        z-index: 1000;
        pointer-events: none;
        opacity: 0;
        transition: all 0.3s ease;
    `;
    
    const rect = button.getBoundingClientRect();
    successText.style.left = rect.left + 'px';
    successText.style.top = rect.top - 30 + 'px';
    
    document.body.appendChild(successText);
    
    // æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => {
        successText.style.opacity = '1';
        successText.style.transform = 'translateY(-10px)';
    }, 10);
    
    // ç§»é™¤åŠ¨ç”»
    setTimeout(() => {
        successText.style.opacity = '0';
        successText.style.transform = 'translateY(-20px)';
        setTimeout(() => {
            if (successText.parentNode) {
                successText.parentNode.removeChild(successText);
            }
        }, 300);
    }, 1500);
    
    // é‡ç½®æŒ‰é’®åŠ¨ç”»
    setTimeout(() => {
        button.style.animation = '';
    }, 600);
}
```

**åŠŸèƒ½**: æ˜¾ç¤ºå‡çº§æˆåŠŸçš„åŠ¨ç”»æ•ˆæœ

### 2. é‡‘å¸ä¸è¶³åŠ¨ç”» (showInsufficientCoins)

```javascript
showInsufficientCoins(button) {
    // æ·»åŠ éœ‡åŠ¨åŠ¨ç”»
    button.style.animation = 'shake 0.5s ease';
    
    // åˆ›å»ºé‡‘å¸ä¸è¶³æç¤º
    const errorText = document.createElement('div');
    errorText.textContent = 'é‡‘å¸ä¸è¶³!';
    errorText.style.cssText = `
        position: absolute;
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: bold;
        z-index: 1000;
        pointer-events: none;
        opacity: 0;
        transition: all 0.3s ease;
    `;
    
    const rect = button.getBoundingClientRect();
    errorText.style.left = rect.left + 'px';
    errorText.style.top = rect.top - 30 + 'px';
    
    document.body.appendChild(errorText);
    
    // æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => {
        errorText.style.opacity = '1';
        errorText.style.transform = 'translateY(-10px)';
    }, 10);
    
    // ç§»é™¤åŠ¨ç”»
    setTimeout(() => {
        errorText.style.opacity = '0';
        errorText.style.transform = 'translateY(-20px)';
        setTimeout(() => {
            if (errorText.parentNode) {
                errorText.parentNode.removeChild(errorText);
            }
        }, 300);
    }, 1500);
    
    // é‡ç½®æŒ‰é’®åŠ¨ç”»
    setTimeout(() => {
        button.style.animation = '';
    }, 500);
}
```

**åŠŸèƒ½**: æ˜¾ç¤ºé‡‘å¸ä¸è¶³çš„åŠ¨ç”»æ•ˆæœ

## é•¿æŒ‰å‡çº§èœå•

### 1. é•¿æŒ‰èœå•ç»‘å®š (bindLongPressUpgradeMenu)

```javascript
bindLongPressUpgradeMenu() {
    const upgradeButtons = [
        { id: 'upgradeAttack', attribute: 'attack' },
        { id: 'upgradeHp', attribute: 'hp' },
        { id: 'upgradeHpRegen', attribute: 'hpRegen' },
        { id: 'upgradeCritDamage', attribute: 'critDamage' },
        { id: 'upgradeAttackSpeed', attribute: 'attackSpeed' },
        { id: 'upgradeCrit', attribute: 'crit' },
        { id: 'upgradeMultiShot', attribute: 'multiShot' },
        { id: 'upgradeTripleShot', attribute: 'tripleShot' }
    ];

    upgradeButtons.forEach(({ id, attribute }) => {
        const button = document.getElementById(id);
        if (button) {
            let longPressTimer = null;
            let isLongPress = false;

            // é¼ æ ‡/è§¦æ‘¸å¼€å§‹äº‹ä»¶
            const startLongPress = (e) => {
                e.preventDefault();
                isLongPress = false;
                longPressTimer = setTimeout(() => {
                    isLongPress = true;
                    this.showUpgradeMenu(button, attribute, e);
                }, 500); // é•¿æŒ‰500æ¯«ç§’è§¦å‘
            };

            // é¼ æ ‡/è§¦æ‘¸ç»“æŸäº‹ä»¶
            const endLongPress = (e) => {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                
                // å¦‚æœä¸æ˜¯é•¿æŒ‰ï¼Œæ‰§è¡Œå‡çº§æ“ä½œ
                if (!isLongPress) {
                    const maxAffordable = this.getMaxAffordableUpgrades(attribute);
                    
                    if (maxAffordable > 1) {
                        this.bulkUpgradeAttribute(attribute, maxAffordable);
                    } else if (maxAffordable === 1) {
                        this.upgradeAttribute(attribute);
                    }
                }
                isLongPress = false;
            };

            // ç»‘å®šäº‹ä»¶
            button.addEventListener('mousedown', startLongPress);
            button.addEventListener('mouseup', endLongPress);
            button.addEventListener('mouseleave', endLongPress);
            button.addEventListener('touchstart', startLongPress);
            button.addEventListener('touchend', endLongPress);
            button.addEventListener('touchcancel', endLongPress);
        }
    });

    // ç»‘å®šå­èœå•æŒ‰é’®äº‹ä»¶
    this.bindUpgradeMenuButtons();
}
```

**åŠŸèƒ½**: ä¸ºå‡çº§æŒ‰é’®ç»‘å®šé•¿æŒ‰èœå•åŠŸèƒ½

### 2. æ˜¾ç¤ºå‡çº§èœå• (showUpgradeMenu)

```javascript
showUpgradeMenu(button, attribute, event) {
    const menu = document.getElementById('upgradeMenu');
    if (!menu) return;

    // è®¡ç®—èœå•ä½ç½®
    const rect = button.getBoundingClientRect();
    menu.style.left = `${rect.left}px`;
    menu.style.top = `${rect.bottom + 5}px`;

    // æ›´æ–°èœå•æŒ‰é’®çŠ¶æ€
    this.updateUpgradeMenuButtons(attribute);

    // æ˜¾ç¤ºèœå•
    menu.style.display = 'block';
    menu.dataset.currentAttribute = attribute;

    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
    setTimeout(() => {
        document.addEventListener('click', this.hideUpgradeMenu.bind(this), { once: true });
    }, 100);
}
```

**åŠŸèƒ½**: æ˜¾ç¤ºå‡çº§å­èœå•

## æ€§èƒ½ä¼˜åŒ–

### 1. æ‰¹é‡æ›´æ–°ä¼˜åŒ–
- æ‰¹é‡å‡çº§æ—¶ä½¿ç”¨é™é»˜æ¨¡å¼ï¼Œé¿å…é‡å¤åŠ¨ç”»
- ç»Ÿä¸€åˆ·æ–°UIï¼Œå‡å°‘DOMæ“ä½œ

### 2. è®¡ç®—ä¼˜åŒ–
- ç¼“å­˜è®¡ç®—ç»“æœ
- é¿å…é‡å¤çš„å±æ€§æ£€æŸ¥

### 3. å†…å­˜ç®¡ç†
- åŠæ—¶æ¸…ç†åŠ¨ç”»å…ƒç´ 
- å¤ç”¨DOMå…ƒç´ 

## æ‰©å±•æ€§è®¾è®¡

### 1. æ–°å±æ€§æ·»åŠ 
```javascript
// æ·»åŠ æ–°å±æ€§
this.player.newAttribute = 0;
this.player.upgradeCosts.newAttribute = 100;

// æ·»åŠ å‡çº§å¢é‡
this.attributeIncreases.newAttribute = 5;

// æ·»åŠ å‡çº§é™åˆ¶
if (attribute === 'newAttribute') {
    if (this.player.newAttribute >= 1000) {
        return; // è¾¾åˆ°ä¸Šé™
    }
}
```

### 2. æ–°å‡çº§ç±»å‹
```javascript
// æ·»åŠ æ–°çš„å‡çº§ç±»å‹
if (attribute === 'newType') {
    // ç‰¹æ®Šå¤„ç†é€»è¾‘
    this.player.newType = Math.min(this.player.newType + increase, maxValue);
}
```

### 3. è‡ªå®šä¹‰å‡çº§æ•ˆæœ
```javascript
// æ·»åŠ å‡çº§åçš„ç‰¹æ®Šæ•ˆæœ
if (attribute === 'specialAttribute') {
    this.player.specialAttribute += increase;
    // è§¦å‘ç‰¹æ®Šæ•ˆæœ
    this.triggerSpecialEffect(attribute);
}
```

## æœ€ä½³å®è·µ

### 1. æ•°æ®ä¸€è‡´æ€§
- ç¡®ä¿UIæ˜¾ç¤ºä¸æ•°æ®çŠ¶æ€åŒæ­¥
- ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®æ›´æ–°æ¥å£

### 2. ç”¨æˆ·ä½“éªŒ
- æä¾›æ¸…æ™°çš„åé¦ˆ
- æ”¯æŒå¤šç§æ“ä½œæ–¹å¼
- ä¼˜åŒ–åŠ¨ç”»æ•ˆæœ

### 3. æ€§èƒ½è€ƒè™‘
- é¿å…é¢‘ç¹çš„DOMæ“ä½œ
- ä½¿ç”¨æ‰¹é‡æ›´æ–°
- åˆç†ä½¿ç”¨åŠ¨ç”»

### 4. é”™è¯¯å¤„ç†
- æ£€æŸ¥è¾¹ç•Œæ¡ä»¶
- æä¾›å‹å¥½çš„é”™è¯¯æç¤º
- å®ç°ä¼˜é›…çš„é™çº§å¤„ç†
